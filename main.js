/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var H=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var le=Object.prototype.hasOwnProperty;var ce=(l,i)=>{for(var e in i)H(l,e,{get:i[e],enumerable:!0})},he=(l,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of ae(i))!le.call(l,s)&&s!==e&&H(l,s,{get:()=>i[s],enumerable:!(t=oe(i,s))||t.enumerable});return l};var de=l=>he(H({},"__esModule",{value:!0}),l);var me={};ce(me,{default:()=>A});module.exports=de(me);var h=require("obsidian");var C=class{diff(i,e,t={}){let s;typeof t=="function"?(s=t,t={}):"callback"in t&&(s=t.callback);let n=this.castInput(i,t),r=this.castInput(e,t),o=this.removeEmpty(this.tokenize(n,t)),a=this.removeEmpty(this.tokenize(r,t));return this.diffWithOptionsObj(o,a,t,s)}diffWithOptionsObj(i,e,t,s){var n;let r=f=>{if(f=this.postProcess(f,t),s){setTimeout(function(){s(f)},0);return}else return f},o=e.length,a=i.length,c=1,d=o+a;t.maxEditLength!=null&&(d=Math.min(d,t.maxEditLength));let g=(n=t.timeout)!==null&&n!==void 0?n:1/0,p=Date.now()+g,m=[{oldPos:-1,lastComponent:void 0}],u=this.extractCommon(m[0],e,i,0,t);if(m[0].oldPos+1>=a&&u+1>=o)return r(this.buildValues(m[0].lastComponent,e,i));let y=-1/0,v=1/0,w=()=>{for(let f=Math.max(y,-c);f<=Math.min(v,c);f+=2){let x,E=m[f-1],V=m[f+1];E&&(m[f-1]=void 0);let D=!1;if(V){let L=V.oldPos-f;D=V&&0<=L&&L<o}let O=E&&E.oldPos+1<a;if(!D&&!O){m[f]=void 0;continue}if(!O||D&&E.oldPos<V.oldPos?x=this.addToPath(V,!0,!1,0,t):x=this.addToPath(E,!1,!0,1,t),u=this.extractCommon(x,e,i,f,t),x.oldPos+1>=a&&u+1>=o)return r(this.buildValues(x.lastComponent,e,i))||!0;m[f]=x,x.oldPos+1>=a&&(v=Math.min(v,f-1)),u+1>=o&&(y=Math.max(y,f+1))}c++};if(s)(function f(){setTimeout(function(){if(c>d||Date.now()>p)return s(void 0);w()||f()},0)})();else for(;c<=d&&Date.now()<=p;){let f=w();if(f)return f}}addToPath(i,e,t,s,n){let r=i.lastComponent;return r&&!n.oneChangePerToken&&r.added===e&&r.removed===t?{oldPos:i.oldPos+s,lastComponent:{count:r.count+1,added:e,removed:t,previousComponent:r.previousComponent}}:{oldPos:i.oldPos+s,lastComponent:{count:1,added:e,removed:t,previousComponent:r}}}extractCommon(i,e,t,s,n){let r=e.length,o=t.length,a=i.oldPos,c=a-s,d=0;for(;c+1<r&&a+1<o&&this.equals(t[a+1],e[c+1],n);)c++,a++,d++,n.oneChangePerToken&&(i.lastComponent={count:1,previousComponent:i.lastComponent,added:!1,removed:!1});return d&&!n.oneChangePerToken&&(i.lastComponent={count:d,previousComponent:i.lastComponent,added:!1,removed:!1}),i.oldPos=a,c}equals(i,e,t){return t.comparator?t.comparator(i,e):i===e||!!t.ignoreCase&&i.toLowerCase()===e.toLowerCase()}removeEmpty(i){let e=[];for(let t=0;t<i.length;t++)i[t]&&e.push(i[t]);return e}castInput(i,e){return i}tokenize(i,e){return Array.from(i)}join(i){return i.join("")}postProcess(i,e){return i}get useLongestToken(){return!1}buildValues(i,e,t){let s=[],n;for(;i;)s.push(i),n=i.previousComponent,delete i.previousComponent,i=n;s.reverse();let r=s.length,o=0,a=0,c=0;for(;o<r;o++){let d=s[o];if(d.removed)d.value=this.join(t.slice(c,c+d.count)),c+=d.count;else{if(!d.added&&this.useLongestToken){let g=e.slice(a,a+d.count);g=g.map(function(p,m){let u=t[c+m];return u.length>p.length?u:p}),d.value=this.join(g)}else d.value=this.join(e.slice(a,a+d.count));a+=d.count,d.added||(c+=d.count)}}return s}};var Q=class extends C{},ee=new Q;function k(l,i,e){return ee.diff(l,i,e)}function q(l,i){let e;for(e=0;e<l.length&&e<i.length;e++)if(l[e]!=i[e])return l.slice(0,e);return l.slice(0,e)}function J(l,i){let e;if(!l||!i||l[l.length-1]!=i[i.length-1])return"";for(e=0;e<l.length&&e<i.length;e++)if(l[l.length-(e+1)]!=i[i.length-(e+1)])return l.slice(-e);return l.slice(-e)}function M(l,i,e){if(l.slice(0,i.length)!=i)throw Error(`string ${JSON.stringify(l)} doesn't start with prefix ${JSON.stringify(i)}; this is a bug`);return e+l.slice(i.length)}function N(l,i,e){if(!i)return l+e;if(l.slice(-i.length)!=i)throw Error(`string ${JSON.stringify(l)} doesn't end with suffix ${JSON.stringify(i)}; this is a bug`);return l.slice(0,-i.length)+e}function T(l,i){return M(l,i,"")}function I(l,i){return N(l,i,"")}function G(l,i){return i.slice(0,ue(l,i))}function ue(l,i){let e=0;l.length>i.length&&(e=l.length-i.length);let t=i.length;l.length<i.length&&(t=l.length);let s=Array(t),n=0;s[0]=0;for(let r=1;r<t;r++){for(i[r]==i[n]?s[r]=s[n]:s[r]=n;n>0&&i[r]!=i[n];)n=s[n];i[r]==i[n]&&n++}n=0;for(let r=e;r<l.length;r++){for(;n>0&&l[r]!=i[n];)n=s[n];l[r]==i[n]&&n++}return n}function b(l){let i;for(i=l.length-1;i>=0&&l[i].match(/\s/);i--);return l.substring(i+1)}function S(l){let i=l.match(/^\s*/);return i?i[0]:""}var $="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",fe=new RegExp(`[${$}]+|\\s+|[^${$}]`,"ug"),_=class extends C{equals(i,e,t){return t.ignoreCase&&(i=i.toLowerCase(),e=e.toLowerCase()),i.trim()===e.trim()}tokenize(i,e={}){let t;if(e.intlSegmenter){let r=e.intlSegmenter;if(r.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');t=Array.from(r.segment(i),o=>o.segment)}else t=i.match(fe)||[];let s=[],n=null;return t.forEach(r=>{/\s/.test(r)?n==null?s.push(r):s.push(s.pop()+r):n!=null&&/\s/.test(n)?s[s.length-1]==n?s.push(s.pop()+r):s.push(n+r):s.push(r),n=r}),s}join(i){return i.map((e,t)=>t==0?e:e.replace(/^\s+/,"")).join("")}postProcess(i,e){if(!i||e.oneChangePerToken)return i;let t=null,s=null,n=null;return i.forEach(r=>{r.added?s=r:r.removed?n=r:((s||n)&&te(t,n,s,r),t=r,s=null,n=null)}),(s||n)&&te(t,n,s,null),i}},se=new _;function B(l,i,e){return(e==null?void 0:e.ignoreWhitespace)!=null&&!e.ignoreWhitespace?ne(l,i,e):se.diff(l,i,e)}function te(l,i,e,t){if(i&&e){let s=S(i.value),n=b(i.value),r=S(e.value),o=b(e.value);if(l){let a=q(s,r);l.value=N(l.value,r,a),i.value=T(i.value,a),e.value=T(e.value,a)}if(t){let a=J(n,o);t.value=M(t.value,o,a),i.value=I(i.value,a),e.value=I(e.value,a)}}else if(e){if(l){let s=S(e.value);e.value=e.value.substring(s.length)}if(t){let s=S(t.value);t.value=t.value.substring(s.length)}}else if(l&&t){let s=S(t.value),n=S(i.value),r=b(i.value),o=q(s,n);i.value=T(i.value,o);let a=J(T(s,o),r);i.value=I(i.value,a),t.value=M(t.value,s,a),l.value=N(l.value,s,s.slice(0,s.length-a.length))}else if(t){let s=S(t.value),n=b(i.value),r=G(n,s);i.value=I(i.value,r)}else if(l){let s=b(l.value),n=S(i.value),r=G(s,n);i.value=T(i.value,r)}}var U=class extends C{tokenize(i){let e=new RegExp(`(\\r?\\n)|[${$}]+|[^\\S\\n\\r]+|[^${$}]`,"ug");return i.match(e)||[]}},ie=new U;function ne(l,i,e){return ie.diff(l,i,e)}var X=class extends C{constructor(){super(...arguments),this.tokenize=pe}equals(i,e,t){return t.ignoreWhitespace?((!t.newlineIsToken||!i.includes(`
`))&&(i=i.trim()),(!t.newlineIsToken||!e.includes(`
`))&&(e=e.trim())):t.ignoreNewlineAtEof&&!t.newlineIsToken&&(i.endsWith(`
`)&&(i=i.slice(0,-1)),e.endsWith(`
`)&&(e=e.slice(0,-1))),super.equals(i,e,t)}},re=new X;function W(l,i,e){return re.diff(l,i,e)}function pe(l,i){i.stripTrailingCr&&(l=l.replace(/\r\n/g,`
`));let e=[],t=l.split(/(\n|\r\n)/);t[t.length-1]||t.pop();for(let s=0;s<t.length;s++){let n=t[s];s%2&&!i.newlineIsToken?e[e.length-1]+=n:e.push(n)}return e}var ve={versionFolder:".versions",autoSave:!0,autoSaveInterval:5,autoClear:!0,maxVersions:50,enableMaxVersions:!0,maxDays:30,enableMaxDays:!1,useRelativeTime:!1,diffGranularity:"char",diffViewMode:"unified",enableDeduplication:!0,showNotifications:!0,excludedFolders:[],enableCompression:!1},A=class extends h.Plugin{constructor(){super(...arguments);this.autoSaveTimer=null;this.lastSavedContent=new Map;this.versionCache=new Map}async onload(){await this.loadSettings(),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar(),this.registerView("version-history",e=>new z(e,this)),this.addRibbonIcon("history","\u7248\u672C\u5386\u53F2",()=>{this.activateVersionHistoryView()}),this.addCommand({id:"create-version",name:"\u521B\u5EFA\u7248\u672C\u5FEB\u7167",callback:()=>this.createManualVersion()}),this.addCommand({id:"show-version-history",name:"\u663E\u793A\u7248\u672C\u5386\u53F2",callback:()=>this.activateVersionHistoryView()}),this.addCommand({id:"create-full-snapshot",name:"\u521B\u5EFA\u5168\u5E93\u7248\u672C",callback:()=>this.createFullSnapshot()}),this.addCommand({id:"compare-with-version",name:"\u4E0E\u5386\u53F2\u7248\u672C\u5BF9\u6BD4",callback:()=>this.quickCompare()}),this.addCommand({id:"restore-last-version",name:"\u6062\u590D\u5230\u4E0A\u4E00\u7248\u672C",callback:()=>this.restoreLastVersion()}),this.addSettingTab(new K(this.app,this)),this.registerEvent(this.app.vault.on("modify",e=>{e instanceof h.TFile&&this.settings.autoSave&&this.scheduleAutoSave(e)})),this.settings.autoSave&&this.startAutoSave(),await this.ensureVersionFolder(),this.settings.showNotifications&&new h.Notice("\u7248\u672C\u63A7\u5236\u63D2\u4EF6\u5DF2\u542F\u52A8")}onunload(){this.autoSaveTimer&&clearInterval(this.autoSaveTimer),this.versionCache.clear()}async loadSettings(){this.settings=Object.assign({},ve,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.updateStatusBar()}updateStatusBar(){this.settings.autoSave?this.statusBarItem.setText(`\u23F1 \u7248\u672C\u63A7\u5236: ${this.settings.autoSaveInterval}\u5206\u949F`):this.statusBarItem.setText("\u23F8 \u7248\u672C\u63A7\u5236: \u5DF2\u6682\u505C")}async ensureVersionFolder(){let e=this.app.vault.adapter,t=this.settings.versionFolder;try{await e.exists(t)||await e.mkdir(t)}catch(s){console.error("\u521B\u5EFA\u7248\u672C\u6587\u4EF6\u5939\u5931\u8D25:",s),new h.Notice("\u65E0\u6CD5\u521B\u5EFA\u7248\u672C\u6587\u4EF6\u5939\uFF0C\u8BF7\u68C0\u67E5\u6743\u9650")}}async activateVersionHistoryView(){let{workspace:e}=this.app,t=e.getLeavesOfType("version-history")[0];if(!t){let s=e.getRightLeaf(!1);if(!s){new h.Notice("\u65E0\u6CD5\u6253\u5F00\u7248\u672C\u5386\u53F2\u89C6\u56FE");return}t=s,await t.setViewState({type:"version-history",active:!0})}e.revealLeaf(t)}startAutoSave(){this.autoSaveTimer&&clearInterval(this.autoSaveTimer),this.autoSaveTimer=setInterval(()=>{this.autoSaveCurrentFile()},this.settings.autoSaveInterval*60*1e3)}scheduleAutoSave(e){this.isExcluded(e.path)||setTimeout(()=>{this.autoSaveFile(e)},3e3)}async autoSaveFile(e){try{let t=await this.app.vault.read(e),s=this.lastSavedContent.get(e.path);t!==s&&(await this.createVersion(e,"[Auto Save]",!1),this.lastSavedContent.set(e.path,t))}catch(t){console.error("\u81EA\u52A8\u4FDD\u5B58\u5931\u8D25:",t)}}async autoSaveCurrentFile(){let e=this.app.workspace.getActiveFile();!e||this.isExcluded(e.path)||await this.autoSaveFile(e)}isExcluded(e){return this.settings.excludedFolders.some(t=>e.startsWith(t))}async createManualVersion(){let e=this.app.workspace.getActiveFile();if(!e){new h.Notice("\u6CA1\u6709\u6253\u5F00\u7684\u6587\u4EF6");return}new Z(this.app,async t=>{await this.createVersion(e,t,!0),this.settings.showNotifications&&new h.Notice("\u2713 \u7248\u672C\u5DF2\u521B\u5EFA")}).open()}async createVersion(e,t,s=!1){try{let n=await this.app.vault.read(e),r=Date.now(),o=`${r}`,a=this.hashContent(n),c=await this.loadVersionFile(e.path);if(this.settings.enableDeduplication&&c.versions.find(p=>p.hash===a)){s&&this.settings.showNotifications&&new h.Notice("\u5185\u5BB9\u672A\u53D8\u5316\uFF0C\u8DF3\u8FC7\u521B\u5EFA\u7248\u672C");return}let d={id:o,timestamp:r,message:t,content:n,size:n.length,hash:a};c.versions.unshift(d),c.lastModified=r,this.settings.autoClear&&this.cleanupVersionsInMemory(c),await this.saveVersionFile(e.path,c),this.versionCache.set(e.path,c),this.refreshVersionHistoryView(),s&&this.settings.showNotifications&&new h.Notice(`\u2713 \u7248\u672C\u5DF2\u521B\u5EFA: ${t}`)}catch(n){console.error("\u521B\u5EFA\u7248\u672C\u5931\u8D25:",n),new h.Notice("\u274C \u521B\u5EFA\u7248\u672C\u5931\u8D25\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0")}}hashContent(e){let t=0;for(let s=0;s<e.length;s++){let n=e.charCodeAt(s);t=(t<<5)-t+n,t=t&t}return t.toString(36)}cleanupVersionsInMemory(e){let t=e.versions;if(this.settings.enableMaxVersions&&(t=t.slice(0,this.settings.maxVersions)),this.settings.enableMaxDays){let n=Date.now()-this.settings.maxDays*24*60*60*1e3;t=t.filter(r=>r.timestamp>=n)}let s=e.versions.length-t.length;return e.versions=t,s}async loadVersionFile(e){if(this.versionCache.has(e))return this.versionCache.get(e);let t=this.getVersionFilePath(e),s=this.app.vault.adapter;try{if(await s.exists(t)){let r=await s.read(t),o=JSON.parse(r);return this.versionCache.set(e,o),o}}catch(r){console.error("\u52A0\u8F7D\u7248\u672C\u6587\u4EF6\u5931\u8D25:",r)}let n={filePath:e,versions:[],lastModified:Date.now()};return this.versionCache.set(e,n),n}async saveVersionFile(e,t){let s=this.getVersionFilePath(e),n=this.app.vault.adapter;try{let r=JSON.stringify(t,null,2);await n.write(s,r)}catch(r){throw console.error("\u4FDD\u5B58\u7248\u672C\u6587\u4EF6\u5931\u8D25:",r),r}}getVersionFilePath(e){let t=this.sanitizeFileName(e);return`${this.settings.versionFolder}/${t}.json`}async getVersions(e){try{return(await this.loadVersionFile(e)).versions}catch(t){return console.error("\u83B7\u53D6\u7248\u672C\u5217\u8868\u5931\u8D25:",t),[]}}async getVersionContent(e,t){try{let n=(await this.loadVersionFile(e)).versions.find(r=>r.id===t);if(!n)throw new Error("\u7248\u672C\u4E0D\u5B58\u5728");return n.content}catch(s){throw console.error("\u8BFB\u53D6\u7248\u672C\u5185\u5BB9\u5931\u8D25:",s),new Error("\u65E0\u6CD5\u8BFB\u53D6\u7248\u672C\u5185\u5BB9")}}async deleteVersion(e,t){try{let s=await this.loadVersionFile(e);s.versions=s.versions.filter(n=>n.id!==t),s.lastModified=Date.now(),await this.saveVersionFile(e,s),this.versionCache.set(e,s)}catch(s){console.error("\u5220\u9664\u7248\u672C\u5931\u8D25:",s)}}async deleteVersions(e,t){try{let s=await this.loadVersionFile(e),n=new Set(t);s.versions=s.versions.filter(r=>!n.has(r.id)),s.lastModified=Date.now(),await this.saveVersionFile(e,s),this.versionCache.set(e,s)}catch(s){console.error("\u6279\u91CF\u5220\u9664\u7248\u672C\u5931\u8D25:",s)}}async restoreVersion(e,t){try{await this.createVersion(e,"[Before Restore]",!1);let s=await this.getVersionContent(e.path,t);await this.app.vault.modify(e,s),this.settings.showNotifications&&new h.Notice("\u2713 \u7248\u672C\u5DF2\u6062\u590D"),this.refreshVersionHistoryView()}catch(s){console.error("\u6062\u590D\u7248\u672C\u5931\u8D25:",s),new h.Notice("\u274C \u6062\u590D\u7248\u672C\u5931\u8D25")}}async restoreLastVersion(){let e=this.app.workspace.getActiveFile();if(!e){new h.Notice("\u6CA1\u6709\u6253\u5F00\u7684\u6587\u4EF6");return}let t=await this.getVersions(e.path);if(t.length===0){new h.Notice("\u6CA1\u6709\u53EF\u6062\u590D\u7684\u7248\u672C");return}let s=t[0];new F(this.app,"\u6062\u590D\u5230\u4E0A\u4E00\u7248\u672C",`\u786E\u5B9A\u8981\u6062\u590D\u5230\u7248\u672C: ${this.formatTime(s.timestamp)}\uFF1F`,async()=>{await this.restoreVersion(e,s.id)}).open()}async quickCompare(){let e=this.app.workspace.getActiveFile();if(!e){new h.Notice("\u6CA1\u6709\u6253\u5F00\u7684\u6587\u4EF6");return}let t=await this.getVersions(e.path);if(t.length===0){new h.Notice("\u6CA1\u6709\u5386\u53F2\u7248\u672C\u53EF\u5BF9\u6BD4");return}let s=t[0];new P(this.app,this,e,s.id).open()}async createFullSnapshot(){let e=this.app.vault.getMarkdownFiles(),t=0,s=0,n=new h.Notice("\u6B63\u5728\u521B\u5EFA\u5168\u5E93\u7248\u672C...",0);for(let r of e){if(this.isExcluded(r.path)){s++;continue}try{await this.createVersion(r,"[Full Snapshot]",!1),t++}catch(o){console.error(`\u521B\u5EFA\u7248\u672C\u5931\u8D25: ${r.path}`,o)}}n.hide(),this.settings.showNotifications&&new h.Notice(`\u2713 \u5168\u5E93\u7248\u672C\u5DF2\u521B\u5EFA
\u6210\u529F: ${t} \u4E2A\u6587\u4EF6${s>0?`
\u8DF3\u8FC7: ${s} \u4E2A\u6587\u4EF6`:""}`)}async getStorageStats(){let e=this.app.vault.adapter,t=this.settings.versionFolder;try{if(!await e.exists(t))return{totalSize:0,versionCount:0,fileCount:0};let s=await e.list(t),n=0,r=0,o=0;for(let a of s.files)if(a.endsWith(".json"))try{let c=await e.stat(a);n+=(c==null?void 0:c.size)||0;let d=await e.read(a),g=JSON.parse(d);r+=g.versions.length,o++}catch(c){console.error("\u8BFB\u53D6\u7248\u672C\u6587\u4EF6\u5931\u8D25:",c)}return{totalSize:n,versionCount:r,fileCount:o}}catch(s){return console.error("\u83B7\u53D6\u5B58\u50A8\u7EDF\u8BA1\u5931\u8D25:",s),{totalSize:0,versionCount:0,fileCount:0}}}async exportVersions(e){try{let t=await this.loadVersionFile(e),s=`${this.settings.versionFolder}/export_${Date.now()}.json`;await this.app.vault.adapter.write(s,JSON.stringify(t,null,2)),new h.Notice(`\u2713 \u7248\u672C\u5DF2\u5BFC\u51FA\u5230: ${s}`)}catch(t){console.error("\u5BFC\u51FA\u7248\u672C\u5931\u8D25:",t),new h.Notice("\u274C \u5BFC\u51FA\u5931\u8D25")}}sanitizeFileName(e){return e.replace(/[\/\\:*?"<>|]/g,"_")}formatFileSize(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(2)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`}formatTime(e){return this.settings.useRelativeTime?this.getRelativeTime(e):new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}getRelativeTime(e){let t=Date.now()-e,s=Math.floor(t/1e3),n=Math.floor(s/60),r=Math.floor(n/60),o=Math.floor(r/24),a=Math.floor(o/30),c=Math.floor(o/365);return c>0?`${c} \u5E74\u524D`:a>0?`${a} \u4E2A\u6708\u524D`:o>0?`${o} \u5929\u524D`:r>0?`${r} \u5C0F\u65F6\u524D`:n>0?`${n} \u5206\u949F\u524D`:`${s} \u79D2\u524D`}refreshVersionHistoryView(){this.app.workspace.getLeavesOfType("version-history").forEach(t=>{t.view instanceof z&&t.view.refresh()})}},z=class extends h.ItemView{constructor(e,t){super(e);this.selectedVersions=new Set;this.currentFile=null;this.searchQuery="";this.plugin=t}getViewType(){return"version-history"}getDisplayText(){return"\u7248\u672C\u5386\u53F2"}getIcon(){return"history"}async onOpen(){this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.refresh()})),await this.refresh()}async refresh(){let e=this.containerEl.children[1];e.empty(),e.addClass("version-history-view");let t=this.app.workspace.getActiveFile();if(this.currentFile=t,!t){this.renderEmptyState(e,"\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u6587\u4EF6");return}let s=e.createEl("div",{cls:"version-header"}),n=s.createEl("div",{cls:"version-title"});n.createEl("h3",{text:t.basename}),n.createEl("span",{text:t.path,cls:"version-file-path"});let r=s.createEl("div",{cls:"version-header-actions"}),o=r.createEl("input",{type:"text",placeholder:"\u641C\u7D22\u7248\u672C...",cls:"version-search"});o.value=this.searchQuery,o.addEventListener("input",u=>{this.searchQuery=u.target.value,this.refresh()}),r.createEl("button",{text:"\u521B\u5EFA\u7248\u672C",cls:"mod-cta"}).addEventListener("click",()=>{this.plugin.createManualVersion()}),r.createEl("button",{text:"\u5BFC\u51FA"}).addEventListener("click",()=>{this.plugin.exportVersions(t.path)});let d=await this.plugin.getVersions(t.path);if(d.length===0){this.renderEmptyState(e,"\u6682\u65E0\u7248\u672C\u5386\u53F2");return}let g=this.searchQuery?d.filter(u=>u.message.toLowerCase().includes(this.searchQuery.toLowerCase())||this.plugin.formatTime(u.timestamp).toLowerCase().includes(this.searchQuery.toLowerCase())):d;if(g.length===0){this.renderEmptyState(e,`\u672A\u627E\u5230\u5339\u914D "${this.searchQuery}" \u7684\u7248\u672C`);return}if(this.selectedVersions.size>0){let u=e.createEl("div",{cls:"version-toolbar"});u.createEl("span",{text:`\u5DF2\u9009\u62E9 ${this.selectedVersions.size} \u4E2A\u7248\u672C`}),u.createEl("button",{text:"\u6E05\u7A7A\u9009\u62E9"}).addEventListener("click",()=>{this.selectedVersions.clear(),this.refresh()}),u.createEl("button",{text:"\u6279\u91CF\u5220\u9664",cls:"mod-warning"}).addEventListener("click",()=>this.batchDelete(t))}let p=e.createEl("div",{cls:"version-list"});for(let u of g){let y=p.createEl("div",{cls:"version-item"}),v=y.createEl("input",{type:"checkbox",cls:"version-checkbox"});v.checked=this.selectedVersions.has(u.id),v.addEventListener("change",()=>{v.checked?this.selectedVersions.add(u.id):this.selectedVersions.delete(u.id),this.refresh()});let w=y.createEl("div",{cls:"version-info"});w.createEl("div",{cls:"version-time-row"}).createEl("span",{text:this.plugin.formatTime(u.timestamp),cls:"version-time"});let x=w.createEl("div",{cls:"version-message-row"});u.message.includes("[Auto Save]")?x.createEl("span",{text:"\u81EA\u52A8\u4FDD\u5B58",cls:"version-tag version-tag-auto"}):u.message.includes("[Full Snapshot]")?x.createEl("span",{text:"\u5168\u5E93\u7248\u672C",cls:"version-tag version-tag-snapshot"}):u.message.includes("[Before Restore]")&&x.createEl("span",{text:"\u6062\u590D\u524D\u5907\u4EFD",cls:"version-tag version-tag-backup"}),x.createEl("span",{text:u.message.replace(/\[.*?\]/g,"").trim()||"\u65E0\u63CF\u8FF0",cls:"version-message"}),w.createEl("div",{text:this.plugin.formatFileSize(u.size),cls:"version-size"});let E=y.createEl("div",{cls:"version-actions"});E.createEl("button",{text:"\u6062\u590D",cls:"version-btn"}).addEventListener("click",()=>{this.confirmRestore(t,u.id)});let D=E.createEl("button",{text:"\u6BD4\u8F83",cls:"version-btn"});D.addEventListener("click",()=>{this.showDiffModal(t,u.id)}),D.addEventListener("contextmenu",L=>{L.preventDefault();let R=new h.Menu;R.addItem(j=>j.setTitle("\u4E0E\u5F53\u524D\u6587\u4EF6\u5BF9\u6BD4").setIcon("file-diff").onClick(()=>{this.showDiffModal(t,u.id)})),R.addItem(j=>j.setTitle("\u9009\u62E9\u53E6\u4E00\u4E2A\u7248\u672C\u5BF9\u6BD4").setIcon("files").onClick(()=>{this.selectVersionForCompare(t,u.id)})),R.showAtMouseEvent(L)}),E.createEl("button",{text:"\u5220\u9664",cls:"version-btn mod-warning"}).addEventListener("click",async()=>{await this.plugin.deleteVersion(t.path,u.id),this.plugin.settings.showNotifications&&new h.Notice("\u2713 \u7248\u672C\u5DF2\u5220\u9664"),this.refresh()})}let m=e.createEl("div",{cls:"version-footer"});m.createEl("span",{text:`\u5171 ${d.length} \u4E2A\u7248\u672C`}),this.searchQuery&&m.createEl("span",{text:` \xB7 \u663E\u793A ${g.length} \u4E2A\u7ED3\u679C`})}renderEmptyState(e,t){let s=e.createEl("div",{cls:"version-history-empty"});s.createEl("div",{text:"\u{1F4DD}",cls:"version-empty-icon"}),s.createEl("div",{text:t}),this.currentFile&&t==="\u6682\u65E0\u7248\u672C\u5386\u53F2"&&s.createEl("button",{text:"\u521B\u5EFA\u7B2C\u4E00\u4E2A\u7248\u672C",cls:"mod-cta"}).addEventListener("click",()=>{this.plugin.createManualVersion()})}confirmRestore(e,t){new F(this.app,"\u786E\u8BA4\u6062\u590D\u7248\u672C",`\u5F53\u524D\u672A\u4FDD\u5B58\u7684\u4FEE\u6539\u5C06\u4F1A\u4E22\u5931\uFF0C\u63D2\u4EF6\u4F1A\u5728\u6062\u590D\u524D\u81EA\u52A8\u521B\u5EFA\u5907\u4EFD\u7248\u672C\u3002

\u662F\u5426\u7EE7\u7EED\uFF1F`,async()=>{await this.plugin.restoreVersion(e,t)}).open()}async batchDelete(e){new F(this.app,"\u786E\u8BA4\u6279\u91CF\u5220\u9664",`\u786E\u5B9A\u8981\u5220\u9664\u9009\u4E2D\u7684 ${this.selectedVersions.size} \u4E2A\u7248\u672C\u5417\uFF1F

\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\uFF01`,async()=>{let t=Array.from(this.selectedVersions);await this.plugin.deleteVersions(e.path,t),this.selectedVersions.clear(),this.plugin.settings.showNotifications&&new h.Notice("\u2713 \u5DF2\u5220\u9664\u9009\u4E2D\u7248\u672C"),this.refresh()}).open()}showDiffModal(e,t){new P(this.app,this.plugin,e,t).open()}selectVersionForCompare(e,t){new Y(this.app,this.plugin,e,t,s=>{new P(this.app,this.plugin,e,t,s).open()}).open()}},Z=class extends h.Modal{constructor(e,t){super(e);this.result="";this.onSubmit=t}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"\u521B\u5EFA\u7248\u672C"}),new h.Setting(e).setName("\u63D0\u4EA4\u4FE1\u606F").setDesc("\u63CF\u8FF0\u6B64\u7248\u672C\u7684\u66F4\u6539\u5185\u5BB9").addText(r=>{this.inputEl=r,r.setPlaceholder("\u4F8B\u5982\uFF1A\u6DFB\u52A0\u65B0\u7AE0\u8282\u3001\u4FEE\u590D\u9519\u8BEF\u7B49...").onChange(o=>{this.result=o}),r.inputEl.style.width="100%",r.inputEl.focus()});let t=e.createEl("div",{cls:"modal-button-container"});t.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"\u521B\u5EFA",cls:"mod-cta"}).addEventListener("click",()=>{this.close(),this.onSubmit(this.result||"[Manual Save]")}),this.inputEl.inputEl.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),this.close(),this.onSubmit(this.result||"[Manual Save]"))})}onClose(){let{contentEl:e}=this;e.empty()}},F=class extends h.Modal{constructor(e,t,s,n){super(e);this.title=t,this.message=s,this.onConfirm=n}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:this.title});let t=e.createEl("p",{cls:"confirm-message"});t.style.whiteSpace="pre-line",t.textContent=this.message;let s=e.createEl("div",{cls:"modal-button-container"});s.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>this.close()),s.createEl("button",{text:"\u786E\u8BA4",cls:"mod-warning"}).addEventListener("click",()=>{this.close(),this.onConfirm()})}onClose(){let{contentEl:e}=this;e.empty()}},P=class extends h.Modal{constructor(e,t,s,n,r){super(e);this.currentDiffIndex=0;this.totalDiffs=0;this.diffElements=[];this.plugin=t,this.file=s,this.versionId=n,this.secondVersionId=r}async onOpen(){let{contentEl:e}=this;e.addClass("diff-modal"),e.createEl("h2",{text:"\u7248\u672C\u5DEE\u5F02\u5BF9\u6BD4"});let t=e.createEl("div",{cls:"diff-toolbar"}),s=t.createEl("button",{text:"\u2B06 \u4E0A\u4E00\u4E2A\u5DEE\u5F02"}),n=t.createEl("button",{text:"\u2B07 \u4E0B\u4E00\u4E2A\u5DEE\u5F02"}),r=t.createEl("span",{cls:"diff-stats"}),o=t.createEl("select");o.createEl("option",{text:"\u5B57\u7B26\u7EA7",value:"char"}),o.createEl("option",{text:"\u5355\u8BCD\u7EA7",value:"word"}),o.createEl("option",{text:"\u884C\u7EA7",value:"line"}),o.value=this.plugin.settings.diffGranularity;let a=t.createEl("select");a.createEl("option",{text:"\u7EDF\u4E00\u89C6\u56FE",value:"unified"}),a.createEl("option",{text:"\u5DE6\u53F3\u5206\u680F",value:"split"}),a.value=this.plugin.settings.diffViewMode,t.createEl("button",{text:"\u{1F4CB} \u590D\u5236\u5DEE\u5F02"}).addEventListener("click",()=>{this.copyDiffToClipboard()});let d,g,p,m;try{if(this.secondVersionId){d=await this.plugin.getVersionContent(this.file.path,this.versionId),g=await this.plugin.getVersionContent(this.file.path,this.secondVersionId);let v=await this.plugin.getVersions(this.file.path),w=v.find(x=>x.id===this.versionId),f=v.find(x=>x.id===this.secondVersionId);p=w?`\u7248\u672C A: ${this.plugin.formatTime(w.timestamp)}`:"\u7248\u672C A",m=f?`\u7248\u672C B: ${this.plugin.formatTime(f.timestamp)}`:"\u7248\u672C B"}else{d=await this.plugin.getVersionContent(this.file.path,this.versionId),g=await this.app.vault.read(this.file);let w=(await this.plugin.getVersions(this.file.path)).find(f=>f.id===this.versionId);p=w?`\u5386\u53F2\u7248\u672C: ${this.plugin.formatTime(w.timestamp)}`:"\u5386\u53F2\u7248\u672C",m="\u5F53\u524D\u6587\u4EF6"}}catch(v){new h.Notice("\u274C \u52A0\u8F7D\u7248\u672C\u5185\u5BB9\u5931\u8D25"),this.close();return}let u=e.createEl("div",{cls:"diff-container"}),y=()=>{u.empty(),this.diffElements=[],this.currentDiffIndex=0;let v=o.value;a.value==="unified"?this.renderUnifiedDiff(u,d,g,v):this.renderSplitDiff(u,d,g,v,p,m),this.totalDiffs>0?(r.setText(`${this.currentDiffIndex+1} / ${this.totalDiffs}`),s.disabled=!1,n.disabled=!1):(r.setText("\u65E0\u5DEE\u5F02"),s.disabled=!0,n.disabled=!0)};o.addEventListener("change",()=>{y()}),a.addEventListener("change",()=>{y()}),s.addEventListener("click",()=>{this.currentDiffIndex>0&&(this.currentDiffIndex--,this.scrollToDiff(),r.setText(`${this.currentDiffIndex+1} / ${this.totalDiffs}`))}),n.addEventListener("click",()=>{this.currentDiffIndex<this.totalDiffs-1&&(this.currentDiffIndex++,this.scrollToDiff(),r.setText(`${this.currentDiffIndex+1} / ${this.totalDiffs}`))}),y()}renderUnifiedDiff(e,t,s,n){let r;if(n==="char"?r=k(t,s):n==="word"?r=B(t,s):r=W(t,s),this.totalDiffs=r.filter(o=>o.added||o.removed).length,n==="line"){let o=1,a=0;for(let c of r){let d=c.value.split(`
`);d[d.length-1]===""&&d.pop();for(let g of d){let p=e.createEl("div",{cls:"diff-line"});(c.added||c.removed)&&(p.dataset.diffIndex=String(a),this.diffElements.push(p)),c.added?(p.addClass("diff-added"),p.createEl("span",{cls:"line-number",text:String(o)}),p.createEl("span",{text:`+ ${g}`}),o++,a++):c.removed?(p.addClass("diff-removed"),p.createEl("span",{cls:"line-number",text:""}),p.createEl("span",{text:`- ${g}`}),a++):(p.createEl("span",{cls:"line-number",text:String(o)}),p.createEl("span",{text:`  ${g}`}),o++)}}}else{let o=e.createEl("div",{cls:"diff-line-inline-wrapper"});for(let a of r){let c=o.createEl("span");c.textContent=a.value,a.added?(c.addClass("diff-char-added"),this.diffElements.push(c)):a.removed&&(c.addClass("diff-char-removed"),this.diffElements.push(c))}}this.totalDiffs>0&&setTimeout(()=>this.scrollToDiff(),100)}renderSplitDiff(e,t,s,n,r,o){e.addClass("diff-split");let a=e.createEl("div",{cls:"diff-panel"}),c=e.createEl("div",{cls:"diff-panel"});a.createEl("h3",{text:r}),c.createEl("h3",{text:o});let d=a.createEl("div",{cls:"diff-content"}),g=c.createEl("div",{cls:"diff-content"}),p;if(n==="char"?p=k(t,s):n==="word"?p=B(t,s):p=W(t,s),this.totalDiffs=p.filter(u=>u.added||u.removed).length,n==="line"){let u=1,y=1,v=0;for(let w of p){let f=w.value.split(`
`);f[f.length-1]===""&&f.pop();for(let x of f)if(w.removed){let E=d.createEl("div",{cls:"diff-line diff-removed"});E.dataset.diffIndex=String(v),E.createEl("span",{cls:"line-number",text:String(u)}),E.createEl("span",{text:x}),this.diffElements.push(E),u++,v++}else if(w.added){let E=g.createEl("div",{cls:"diff-line diff-added"});E.dataset.diffIndex=String(v),E.createEl("span",{cls:"line-number",text:String(y)}),E.createEl("span",{text:x}),this.diffElements.push(E),y++,v++}else{let E=d.createEl("div",{cls:"diff-line"});E.createEl("span",{cls:"line-number",text:String(u)}),E.createEl("span",{text:x});let V=g.createEl("div",{cls:"diff-line"});V.createEl("span",{cls:"line-number",text:String(y)}),V.createEl("span",{text:x}),u++,y++}}}else{let u=d.createEl("div",{cls:"diff-line-inline-wrapper"}),y=g.createEl("div",{cls:"diff-line-inline-wrapper"});for(let v of p)if(v.removed){let w=u.createEl("span",{text:v.value});w.addClass("diff-char-removed"),this.diffElements.push(w)}else if(v.added){let w=y.createEl("span",{text:v.value});w.addClass("diff-char-added"),this.diffElements.push(w)}else u.createEl("span",{text:v.value}),y.createEl("span",{text:v.value})}let m=!1;d.addEventListener("scroll",()=>{m||(m=!0,g.scrollTop=d.scrollTop,setTimeout(()=>{m=!1},50))}),g.addEventListener("scroll",()=>{m||(m=!0,d.scrollTop=g.scrollTop,setTimeout(()=>{m=!1},50))})}scrollToDiff(){if(this.diffElements.length===0||this.currentDiffIndex>=this.diffElements.length)return;let e=this.diffElements[this.currentDiffIndex];e.scrollIntoView({behavior:"smooth",block:"center"}),this.diffElements.forEach(t=>t.removeClass("diff-current")),e.addClass("diff-current")}copyDiffToClipboard(){let e=this.containerEl.querySelector(".diff-container");if(!e)return;let t=e.textContent||"";navigator.clipboard.writeText(t).then(()=>{new h.Notice("\u2713 \u5DEE\u5F02\u5185\u5BB9\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F")}).catch(()=>{new h.Notice("\u274C \u590D\u5236\u5931\u8D25")})}onClose(){let{contentEl:e}=this;e.empty()}},Y=class extends h.Modal{constructor(e,t,s,n,r){super(e);this.searchQuery="";this.plugin=t,this.file=s,this.firstVersionId=n,this.onSelect=r}async onOpen(){let{contentEl:e}=this;e.addClass("version-select-modal"),e.createEl("h2",{text:"\u9009\u62E9\u5BF9\u6BD4\u7248\u672C"}),e.createEl("p",{text:"\u9009\u62E9\u8981\u4E0E\u4E4B\u5BF9\u6BD4\u7684\u7248\u672C",cls:"version-select-hint"}),e.createEl("div",{cls:"version-search-container"}).createEl("input",{type:"text",placeholder:"\u641C\u7D22\u7248\u672C...",cls:"version-search-input"}).addEventListener("input",r=>{this.searchQuery=r.target.value,this.renderVersionList()});let n=e.createEl("div",{cls:"version-select-list"});this.renderVersionList()}async renderVersionList(){let e=this.containerEl.querySelector(".version-select-list");if(!e)return;e.empty();let s=(await this.plugin.getVersions(this.file.path)).filter(n=>{if(n.id===this.firstVersionId)return!1;if(!this.searchQuery)return!0;let r=this.searchQuery.toLowerCase();return n.message.toLowerCase().includes(r)||this.plugin.formatTime(n.timestamp).toLowerCase().includes(r)});if(s.length===0){e.createEl("div",{text:this.searchQuery?`\u672A\u627E\u5230\u5339\u914D "${this.searchQuery}" \u7684\u7248\u672C`:"\u6CA1\u6709\u5176\u4ED6\u7248\u672C",cls:"version-select-empty"});return}for(let n of s){let r=e.createEl("div",{cls:"version-select-item"}),o=r.createEl("div",{cls:"version-info"});o.createEl("div",{text:this.plugin.formatTime(n.timestamp),cls:"version-time"}),o.createEl("div",{text:n.message,cls:"version-message"}),o.createEl("div",{text:this.plugin.formatFileSize(n.size),cls:"version-size"}),r.createEl("button",{text:"\u9009\u62E9"}).addEventListener("click",()=>{this.close(),this.onSelect(n.id)})}}onClose(){let{contentEl:e}=this;e.empty()}},K=class extends h.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}async display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"\u7248\u672C\u63A7\u5236\u8BBE\u7F6E"});let t=await this.plugin.getStorageStats(),s=e.createEl("div",{cls:"version-stats"});s.createEl("h3",{text:"\u{1F4CA} \u5B58\u50A8\u7EDF\u8BA1"});let n=s.createEl("div",{cls:"stats-grid"});n.createEl("div",{text:`\u603B\u5927\u5C0F: ${this.plugin.formatFileSize(t.totalSize)}`}),n.createEl("div",{text:`\u7248\u672C\u6570\u91CF: ${t.versionCount}`}),n.createEl("div",{text:`\u6587\u4EF6\u6570\u91CF: ${t.fileCount}`}),s.createEl("button",{text:"\u{1F504} \u5237\u65B0\u7EDF\u8BA1"}).addEventListener("click",()=>{this.display()}),e.createEl("h3",{text:"\u2699\uFE0F \u57FA\u7840\u8BBE\u7F6E"}),new h.Setting(e).setName("\u7248\u672C\u5B58\u50A8\u8DEF\u5F84").setDesc("\u6307\u5B9A\u7248\u672C\u6570\u636E\u7684\u5B58\u50A8\u4F4D\u7F6E\uFF08\u76F8\u5BF9\u4E8E\u5E93\u6839\u76EE\u5F55\uFF09").addText(o=>o.setPlaceholder(".versions").setValue(this.plugin.settings.versionFolder).onChange(async a=>{this.plugin.settings.versionFolder=a||".versions",await this.plugin.saveSettings(),await this.plugin.ensureVersionFolder()})),new h.Setting(e).setName("\u663E\u793A\u901A\u77E5").setDesc("\u5728\u521B\u5EFA\u3001\u6062\u590D\u7248\u672C\u65F6\u663E\u793A\u63D0\u793A\u6D88\u606F").addToggle(o=>o.setValue(this.plugin.settings.showNotifications).onChange(async a=>{this.plugin.settings.showNotifications=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u{1F916} \u81EA\u52A8\u4FDD\u5B58"}),new h.Setting(e).setName("\u542F\u7528\u81EA\u52A8\u4FDD\u5B58").setDesc("\u5B9A\u671F\u81EA\u52A8\u521B\u5EFA\u7248\u672C").addToggle(o=>o.setValue(this.plugin.settings.autoSave).onChange(async a=>{this.plugin.settings.autoSave=a,await this.plugin.saveSettings(),a?this.plugin.startAutoSave():this.plugin.autoSaveTimer&&clearInterval(this.plugin.autoSaveTimer)})),new h.Setting(e).setName("\u81EA\u52A8\u4FDD\u5B58\u95F4\u9694 (\u5206\u949F)").setDesc("\u68C0\u6D4B\u6587\u4EF6\u53D8\u5316\u7684\u65F6\u95F4\u95F4\u9694").addText(o=>o.setPlaceholder("5").setValue(String(this.plugin.settings.autoSaveInterval)).onChange(async a=>{let c=parseInt(a);!isNaN(c)&&c>0&&(this.plugin.settings.autoSaveInterval=c,await this.plugin.saveSettings(),this.plugin.settings.autoSave&&this.plugin.startAutoSave())})),new h.Setting(e).setName("\u542F\u7528\u53BB\u91CD").setDesc("\u8DF3\u8FC7\u5185\u5BB9\u76F8\u540C\u7684\u7248\u672C\u521B\u5EFA\uFF0C\u8282\u7701\u5B58\u50A8\u7A7A\u95F4").addToggle(o=>o.setValue(this.plugin.settings.enableDeduplication).onChange(async a=>{this.plugin.settings.enableDeduplication=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("\u6392\u9664\u7684\u6587\u4EF6\u5939").setDesc("\u4E0D\u5BF9\u8FD9\u4E9B\u6587\u4EF6\u5939\u4E2D\u7684\u6587\u4EF6\u521B\u5EFA\u7248\u672C\uFF08\u6BCF\u884C\u4E00\u4E2A\u8DEF\u5F84\uFF09").addTextArea(o=>{o.setValue(this.plugin.settings.excludedFolders.join(`
`)).setPlaceholder(`\u4F8B\u5982:
templates/
.trash/`).onChange(async a=>{this.plugin.settings.excludedFolders=a.split(`
`).map(c=>c.trim()).filter(c=>c.length>0),await this.plugin.saveSettings()}),o.inputEl.rows=4,o.inputEl.style.width="100%"}),e.createEl("h3",{text:"\u{1F5D1}\uFE0F \u81EA\u52A8\u6E05\u7406"}),new h.Setting(e).setName("\u542F\u7528\u81EA\u52A8\u6E05\u7406").setDesc("\u81EA\u52A8\u5220\u9664\u65E7\u7248\u672C\u4EE5\u8282\u7701\u7A7A\u95F4").addToggle(o=>o.setValue(this.plugin.settings.autoClear).onChange(async a=>{this.plugin.settings.autoClear=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("\u6309\u6570\u91CF\u6E05\u7406").setDesc("\u4FDD\u7559\u6307\u5B9A\u6570\u91CF\u7684\u6700\u65B0\u7248\u672C").addToggle(o=>o.setValue(this.plugin.settings.enableMaxVersions).onChange(async a=>{this.plugin.settings.enableMaxVersions=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("\u6700\u5927\u7248\u672C\u6570").setDesc("\u6BCF\u4E2A\u6587\u4EF6\u6700\u591A\u4FDD\u7559\u7684\u7248\u672C\u6570\u91CF").addText(o=>o.setPlaceholder("50").setValue(String(this.plugin.settings.maxVersions)).onChange(async a=>{let c=parseInt(a);!isNaN(c)&&c>0&&(this.plugin.settings.maxVersions=c,await this.plugin.saveSettings())})),new h.Setting(e).setName("\u6309\u5929\u6570\u6E05\u7406").setDesc("\u81EA\u52A8\u5220\u9664\u8D85\u8FC7\u6307\u5B9A\u5929\u6570\u7684\u7248\u672C").addToggle(o=>o.setValue(this.plugin.settings.enableMaxDays).onChange(async a=>{this.plugin.settings.enableMaxDays=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("\u6700\u5927\u4FDD\u7559\u5929\u6570").setDesc("\u5220\u9664\u8D85\u8FC7\u6B64\u5929\u6570\u7684\u65E7\u7248\u672C").addText(o=>o.setPlaceholder("30").setValue(String(this.plugin.settings.maxDays)).onChange(async a=>{let c=parseInt(a);!isNaN(c)&&c>0&&(this.plugin.settings.maxDays=c,await this.plugin.saveSettings())})),e.createEl("h3",{text:"\u{1F3A8} \u663E\u793A\u8BBE\u7F6E"}),new h.Setting(e).setName("\u4F7F\u7528\u76F8\u5BF9\u65F6\u95F4").setDesc('\u663E\u793A"3\u5C0F\u65F6\u524D"\u800C\u4E0D\u662F\u5177\u4F53\u65F6\u95F4').addToggle(o=>o.setValue(this.plugin.settings.useRelativeTime).onChange(async a=>{this.plugin.settings.useRelativeTime=a,await this.plugin.saveSettings(),this.plugin.refreshVersionHistoryView()})),e.createEl("h3",{text:"\u{1F500} \u5DEE\u5F02\u5BF9\u6BD4\u8BBE\u7F6E"}),new h.Setting(e).setName("\u5DEE\u5F02\u7C92\u5EA6").setDesc("\u9009\u62E9\u5DEE\u5F02\u8BA1\u7B97\u7684\u7CBE\u7EC6\u7A0B\u5EA6").addDropdown(o=>o.addOption("char","\u5B57\u7B26\u7EA7 - \u6700\u7CBE\u786E\uFF0C\u663E\u793A\u6BCF\u4E2A\u5B57\u7B26\u7684\u53D8\u5316").addOption("word","\u5355\u8BCD\u7EA7 - \u6309\u5355\u8BCD\u663E\u793A\u5DEE\u5F02").addOption("line","\u884C\u7EA7 - \u6309\u884C\u663E\u793A\u5DEE\u5F02").setValue(this.plugin.settings.diffGranularity).onChange(async a=>{this.plugin.settings.diffGranularity=a,await this.plugin.saveSettings()})),new h.Setting(e).setName("\u9ED8\u8BA4\u89C6\u56FE\u6A21\u5F0F").setDesc("\u9009\u62E9\u5DEE\u5F02\u5BF9\u6BD4\u7684\u9ED8\u8BA4\u663E\u793A\u65B9\u5F0F").addDropdown(o=>o.addOption("unified","\u7EDF\u4E00\u89C6\u56FE - \u4E0A\u4E0B\u5BF9\u6BD4").addOption("split","\u5DE6\u53F3\u5206\u680F - \u5E76\u6392\u663E\u793A").setValue(this.plugin.settings.diffViewMode).onChange(async a=>{this.plugin.settings.diffViewMode=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u{1F6E0}\uFE0F \u7EF4\u62A4\u64CD\u4F5C"}),new h.Setting(e).setName("\u6E05\u7406\u6240\u6709\u7248\u672C").setDesc("\u5220\u9664\u6240\u6709\u7248\u672C\u6570\u636E\uFF08\u8C28\u614E\u64CD\u4F5C\uFF09").addButton(o=>o.setButtonText("\u6E05\u7A7A\u6240\u6709\u7248\u672C").setWarning().onClick(async()=>{new F(this.app,"\u786E\u8BA4\u6E05\u7A7A\u6240\u6709\u7248\u672C",`\u6B64\u64CD\u4F5C\u5C06\u5220\u9664\u6240\u6709\u6587\u4EF6\u7684\u6240\u6709\u7248\u672C\u5386\u53F2\uFF01

\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\uFF0C\u8BF7\u8C28\u614E\u64CD\u4F5C\uFF01`,async()=>{await this.clearAllVersions()}).open()})),new h.Setting(e).setName("\u5BFC\u51FA\u7248\u672C\u6570\u636E").setDesc("\u5C06\u7248\u672C\u6587\u4EF6\u5939\u6253\u5305\u5BFC\u51FA").addButton(o=>o.setButtonText("\u521B\u5EFA\u5907\u4EFD").onClick(async()=>{new h.Notice("\u8BF7\u624B\u52A8\u590D\u5236 .versions \u6587\u4EF6\u5939\u8FDB\u884C\u5907\u4EFD")}))}async clearAllVersions(){try{let e=this.app.vault.adapter,t=this.plugin.settings.versionFolder;if(await e.exists(t)){let s=await e.list(t),n=0;for(let r of s.files)r.endsWith(".json")&&(await e.remove(r),n++);this.plugin.versionCache.clear(),new h.Notice(`\u2713 \u5DF2\u6E05\u7A7A\u6240\u6709\u7248\u672C\uFF08\u5220\u9664 ${n} \u4E2A\u7248\u672C\u6587\u4EF6\uFF09`),this.plugin.refreshVersionHistoryView(),this.display()}}catch(e){console.error("\u6E05\u7A7A\u7248\u672C\u5931\u8D25:",e),new h.Notice("\u274C \u6E05\u7A7A\u5931\u8D25\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0")}}};
