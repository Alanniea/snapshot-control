/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var u=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var F=(o,i)=>{for(var t in i)u(o,t,{get:i[t],enumerable:!0})},E=(o,i,t,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let e of y(i))!b.call(o,e)&&e!==t&&u(o,e,{get:()=>i[e],enumerable:!(s=x(i,e))||s.enumerable});return o};var I=o=>E(u({},"__esModule",{value:!0}),o);var D={};F(D,{default:()=>d});module.exports=I(D);var a=require("obsidian"),P={snapshotFolder:".snapshots",maxSnapshots:50,autoSnapshot:!1,autoSnapshotInterval:5},d=class extends a.Plugin{constructor(){super(...arguments);this.autoSaveIntervalId=null}async onload(){await this.loadSettings(),this.addRibbonIcon("clock-rotate-left","\u5FEB\u7167\u7248\u672C\u63A7\u5236",()=>{new c(this.app,this).open()}),this.addCommand({id:"create-snapshot",name:"\u521B\u5EFA\u5F53\u524D\u6587\u4EF6\u5FEB\u7167",callback:()=>{this.createSnapshot()}}),this.addCommand({id:"view-snapshots",name:"\u67E5\u770B\u5FEB\u7167\u5217\u8868",callback:()=>{new c(this.app,this).open()}}),this.addCommand({id:"restore-snapshot",name:"\u6062\u590D\u5FEB\u7167",callback:()=>{new c(this.app,this).open()}}),this.addSettingTab(new S(this.app,this)),this.settings.autoSnapshot&&this.startAutoSave(),console.log("\u5FEB\u7167\u7248\u672C\u63A7\u5236\u63D2\u4EF6\u5DF2\u52A0\u8F7D")}onunload(){this.autoSaveIntervalId&&window.clearInterval(this.autoSaveIntervalId),console.log("\u5FEB\u7167\u7248\u672C\u63A7\u5236\u63D2\u4EF6\u5DF2\u5378\u8F7D")}async loadSettings(){this.settings=Object.assign({},P,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async createSnapshot(t=""){let s=this.app.workspace.getActiveFile();if(!s){new a.Notice("\u6CA1\u6709\u6253\u5F00\u7684\u6587\u4EF6");return}try{let e=await this.app.vault.read(s),n={id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,filePath:s.path,timestamp:Date.now(),content:e,note:t};await this.saveSnapshot(n),await this.cleanOldSnapshots(s.path),new a.Notice("\u5FEB\u7167\u521B\u5EFA\u6210\u529F")}catch(e){console.error("\u521B\u5EFA\u5FEB\u7167\u5931\u8D25:",e),new a.Notice("\u5FEB\u7167\u521B\u5EFA\u5931\u8D25")}}async saveSnapshot(t){let s=this.settings.snapshotFolder;await this.app.vault.adapter.exists(s)||await this.app.vault.adapter.mkdir(s);let n=this.getSnapshotFolderForFile(t.filePath);await this.app.vault.adapter.exists(n)||await this.app.vault.adapter.mkdir(n);let p=`${n}/${t.id}.json`;await this.app.vault.adapter.write(p,JSON.stringify(t,null,2))}getSnapshotFolderForFile(t){let s=t.replace(/\//g,"_").replace(/\\/g,"_");return`${this.settings.snapshotFolder}/${s}`}async getSnapshots(t){let s=this.getSnapshotFolderForFile(t);if(!await this.app.vault.adapter.exists(s))return[];try{let n=await this.app.vault.adapter.list(s),l=[];for(let p of n.files)if(p.endsWith(".json")){let h=await this.app.vault.adapter.read(p),r=JSON.parse(h);l.push(r)}return l.sort((p,h)=>h.timestamp-p.timestamp),l}catch(n){return console.error("\u8BFB\u53D6\u5FEB\u7167\u5931\u8D25:",n),[]}}async cleanOldSnapshots(t){let s=await this.getSnapshots(t);if(s.length>this.settings.maxSnapshots){let e=s.slice(this.settings.maxSnapshots),n=this.getSnapshotFolderForFile(t);for(let l of e){let p=`${n}/${l.id}.json`;await this.app.vault.adapter.remove(p)}}}async restoreSnapshot(t){try{let s=this.app.vault.getAbstractFileByPath(t.filePath);s instanceof a.TFile?(await this.app.vault.modify(s,t.content),new a.Notice("\u5FEB\u7167\u6062\u590D\u6210\u529F")):new a.Notice("\u6587\u4EF6\u4E0D\u5B58\u5728")}catch(s){console.error("\u6062\u590D\u5FEB\u7167\u5931\u8D25:",s),new a.Notice("\u6062\u590D\u5FEB\u7167\u5931\u8D25")}}async deleteSnapshot(t){try{let e=`${this.getSnapshotFolderForFile(t.filePath)}/${t.id}.json`;await this.app.vault.adapter.remove(e),new a.Notice("\u5FEB\u7167\u5DF2\u5220\u9664")}catch(s){console.error("\u5220\u9664\u5FEB\u7167\u5931\u8D25:",s),new a.Notice("\u5220\u9664\u5FEB\u7167\u5931\u8D25")}}startAutoSave(){this.autoSaveIntervalId&&window.clearInterval(this.autoSaveIntervalId),this.autoSaveIntervalId=window.setInterval(()=>{this.app.workspace.getActiveFile()&&this.createSnapshot("\u81EA\u52A8\u5FEB\u7167")},this.settings.autoSnapshotInterval*60*1e3)}stopAutoSave(){this.autoSaveIntervalId&&(window.clearInterval(this.autoSaveIntervalId),this.autoSaveIntervalId=null)}},c=class extends a.Modal{constructor(t,s){super(t);this.plugin=s}async onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("snapshot-modal"),t.createEl("h2",{text:"\u5FEB\u7167\u7248\u672C\u63A7\u5236"});let s=this.app.workspace.getActiveFile();if(!s){t.createEl("p",{text:"\u6CA1\u6709\u6253\u5F00\u7684\u6587\u4EF6"});return}t.createEl("p",{text:`\u5F53\u524D\u6587\u4EF6: ${s.name}`}),t.createDiv({cls:"snapshot-button-container"}).createEl("button",{text:"\u521B\u5EFA\u65B0\u5FEB\u7167"}).addEventListener("click",async()=>{new g(this.app,this.plugin,()=>{this.onOpen()}).open()});let l=await this.plugin.getSnapshots(s.path);if(l.length===0){t.createEl("p",{text:"\u6682\u65E0\u5FEB\u7167\u8BB0\u5F55"});return}let p=t.createDiv({cls:"snapshot-list"});for(let r of l){let v=p.createDiv({cls:"snapshot-item"}),m=v.createDiv({cls:"snapshot-info"}),w=new Date(r.timestamp);m.createEl("div",{text:`\u65F6\u95F4: ${w.toLocaleString("zh-CN")}`,cls:"snapshot-timestamp"}),r.note&&m.createEl("div",{text:`\u5907\u6CE8: ${r.note}`,cls:"snapshot-note"});let f=v.createDiv({cls:"snapshot-actions"});f.createEl("button",{text:"\u6062\u590D"}).addEventListener("click",async()=>{await this.plugin.restoreSnapshot(r),this.close()}),f.createEl("button",{text:"\u5220\u9664"}).addEventListener("click",async()=>{await this.plugin.deleteSnapshot(r),this.onOpen()})}let h=t.createEl("style");h.textContent=`
            .snapshot-modal {
                padding: 20px;
            }
            .snapshot-button-container {
                margin: 15px 0;
            }
            .snapshot-list {
                margin-top: 20px;
                max-height: 400px;
                overflow-y: auto;
            }
            .snapshot-item {
                border: 1px solid var(--background-modifier-border);
                border-radius: 5px;
                padding: 10px;
                margin-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .snapshot-info {
                flex: 1;
            }
            .snapshot-timestamp {
                font-weight: bold;
                margin-bottom: 5px;
            }
            .snapshot-note {
                color: var(--text-muted);
                font-size: 0.9em;
            }
            .snapshot-actions {
                display: flex;
                gap: 5px;
            }
            .snapshot-actions button {
                padding: 5px 10px;
                cursor: pointer;
            }
        `}onClose(){let{contentEl:t}=this;t.empty()}},g=class extends a.Modal{constructor(t,s,e){super(t);this.plugin=s,this.onSubmit=e}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u521B\u5EFA\u5FEB\u7167"}),new a.Setting(t).setName("\u5907\u6CE8").setDesc("\u4E3A\u8FD9\u4E2A\u5FEB\u7167\u6DFB\u52A0\u5907\u6CE8(\u53EF\u9009)").addText(s=>{s.inputEl.style.width="100%",s.onChange(()=>{});let e=t.createDiv({cls:"modal-button-container"});e.style.marginTop="20px",e.style.display="flex",e.style.gap="10px",e.createEl("button",{text:"\u521B\u5EFA"}).addEventListener("click",async()=>{await this.plugin.createSnapshot(s.getValue()),this.close(),this.onSubmit()}),e.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.close()})})}onClose(){let{contentEl:t}=this;t.empty()}},S=class extends a.PluginSettingTab{constructor(t,s){super(t,s);this.plugin=s}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"\u5FEB\u7167\u7248\u672C\u63A7\u5236\u8BBE\u7F6E"}),new a.Setting(t).setName("\u5FEB\u7167\u5B58\u50A8\u6587\u4EF6\u5939").setDesc("\u5FEB\u7167\u6587\u4EF6\u7684\u5B58\u50A8\u4F4D\u7F6E").addText(s=>s.setPlaceholder(".snapshots").setValue(this.plugin.settings.snapshotFolder).onChange(async e=>{this.plugin.settings.snapshotFolder=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("\u6700\u5927\u5FEB\u7167\u6570\u91CF").setDesc("\u6BCF\u4E2A\u6587\u4EF6\u4FDD\u7559\u7684\u6700\u5927\u5FEB\u7167\u6570\u91CF").addText(s=>s.setPlaceholder("50").setValue(String(this.plugin.settings.maxSnapshots)).onChange(async e=>{let n=parseInt(e);!isNaN(n)&&n>0&&(this.plugin.settings.maxSnapshots=n,await this.plugin.saveSettings())})),new a.Setting(t).setName("\u81EA\u52A8\u5FEB\u7167").setDesc("\u5B9A\u671F\u81EA\u52A8\u521B\u5EFA\u5FEB\u7167").addToggle(s=>s.setValue(this.plugin.settings.autoSnapshot).onChange(async e=>{this.plugin.settings.autoSnapshot=e,await this.plugin.saveSettings(),e?this.plugin.startAutoSave():this.plugin.stopAutoSave()})),new a.Setting(t).setName("\u81EA\u52A8\u5FEB\u7167\u95F4\u9694").setDesc("\u81EA\u52A8\u521B\u5EFA\u5FEB\u7167\u7684\u65F6\u95F4\u95F4\u9694(\u5206\u949F)").addText(s=>s.setPlaceholder("5").setValue(String(this.plugin.settings.autoSnapshotInterval)).onChange(async e=>{let n=parseInt(e);!isNaN(n)&&n>0&&(this.plugin.settings.autoSnapshotInterval=n,await this.plugin.saveSettings(),this.plugin.settings.autoSnapshot&&this.plugin.startAutoSave())}))}};
