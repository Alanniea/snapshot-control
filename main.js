/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var r=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var x=(h,o)=>{for(var t in o)r(h,t,{get:o[t],enumerable:!0})},y=(h,o,t,s)=>{if(o&&typeof o=="object"||typeof o=="function")for(let e of v(o))!f.call(h,e)&&e!==t&&r(h,e,{get:()=>o[e],enumerable:!(s=w(o,e))||s.enumerable});return h};var E=h=>y(r({},"__esModule",{value:!0}),h);var P={};x(P,{default:()=>c});module.exports=E(P);var a=require("obsidian"),F={snapshotFolder:".snapshots",autoSnapshot:!0,maxSnapshots:50,snapshotInterval:30},c=class extends a.Plugin{constructor(){super(...arguments);this.lastSaveTime=new Map}async onload(){await this.loadSettings(),await this.ensureSnapshotFolder(),this.addCommand({id:"create-snapshot",name:"\u521B\u5EFA\u5F53\u524D\u6587\u4EF6\u5FEB\u7167",callback:()=>this.createSnapshot()}),this.addCommand({id:"view-snapshots",name:"\u67E5\u770B\u5FEB\u7167\u5386\u53F2",callback:()=>this.viewSnapshots()}),this.addCommand({id:"restore-snapshot",name:"\u6062\u590D\u5FEB\u7167",callback:()=>this.showRestoreModal()}),this.addCommand({id:"clean-snapshots",name:"\u6E05\u7406\u65E7\u5FEB\u7167",callback:()=>this.cleanOldSnapshots()}),this.settings.autoSnapshot&&this.registerEvent(this.app.vault.on("modify",t=>{t instanceof a.TFile&&this.autoCreateSnapshot(t)})),this.addSettingTab(new m(this.app,this)),this.addRibbonIcon("history","\u5FEB\u7167\u7BA1\u7406",()=>{this.viewSnapshots()})}async ensureSnapshotFolder(){let t=this.settings.snapshotFolder;await this.app.vault.adapter.exists(t)||await this.app.vault.createFolder(t)}async createSnapshot(t,s){let e=t||this.app.workspace.getActiveFile();if(!e){new a.Notice("\u6CA1\u6709\u6D3B\u52A8\u6587\u4EF6");return}try{let n=await this.app.vault.read(e),i={id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,filePath:e.path,timestamp:Date.now(),content:n,size:n.length,note:s||""},p=`${this.settings.snapshotFolder}/${this.sanitizeFileName(e.path)}_${i.id}.json`;await this.app.vault.create(p,JSON.stringify(i,null,2)),new a.Notice(`\u5FEB\u7167\u5DF2\u521B\u5EFA: ${e.name}`),await this.cleanOldSnapshots(e.path)}catch(n){new a.Notice(`\u521B\u5EFA\u5FEB\u7167\u5931\u8D25: ${n.message}`),console.error(n)}}async autoCreateSnapshot(t){let s=this.lastSaveTime.get(t.path)||0,e=Date.now(),n=this.settings.snapshotInterval*60*1e3;e-s>=n&&(await this.createSnapshot(t),this.lastSaveTime.set(t.path,e))}async getSnapshots(t){let s=this.app.vault.getFiles().filter(n=>n.path.startsWith(this.settings.snapshotFolder)&&n.extension==="json"),e=[];for(let n of s)try{let i=await this.app.vault.read(n),p=JSON.parse(i);(!t||p.filePath===t)&&e.push(p)}catch(i){console.error(`\u8BFB\u53D6\u5FEB\u7167\u5931\u8D25: ${n.path}`,i)}return e.sort((n,i)=>i.timestamp-n.timestamp)}async restoreSnapshot(t){try{let s=this.app.vault.getAbstractFileByPath(t.filePath);s instanceof a.TFile?(await this.createSnapshot(s,"\u6062\u590D\u524D\u81EA\u52A8\u4FDD\u5B58"),await this.app.vault.modify(s,t.content),new a.Notice(`\u5DF2\u6062\u590D\u5FEB\u7167: ${new Date(t.timestamp).toLocaleString()}`)):new a.Notice("\u539F\u6587\u4EF6\u4E0D\u5B58\u5728\uFF0C\u65E0\u6CD5\u6062\u590D")}catch(s){new a.Notice(`\u6062\u590D\u5FEB\u7167\u5931\u8D25: ${s.message}`),console.error(s)}}async cleanOldSnapshots(t){let s=await this.getSnapshots(t),e=this.settings.maxSnapshots;if(s.length>e){let n=s.slice(e);for(let i of n){let p=`${this.settings.snapshotFolder}/${this.sanitizeFileName(i.filePath)}_${i.id}.json`,l=this.app.vault.getAbstractFileByPath(p);l instanceof a.TFile&&await this.app.vault.delete(l)}new a.Notice(`\u5DF2\u6E05\u7406 ${n.length} \u4E2A\u65E7\u5FEB\u7167`)}}viewSnapshots(){new g(this.app,this).open()}showRestoreModal(){new d(this.app,this).open()}sanitizeFileName(t){return t.replace(/[/\\:*?"<>|]/g,"_")}async loadSettings(){this.settings=Object.assign({},F,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},g=class extends a.Modal{constructor(t,s){super(t);this.plugin=s}async onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u5FEB\u7167\u5386\u53F2"});let s=this.app.workspace.getActiveFile(),e=await this.plugin.getSnapshots(s==null?void 0:s.path);if(e.length===0){t.createEl("p",{text:"\u6682\u65E0\u5FEB\u7167"});return}let n=t.createDiv({cls:"snapshot-list"});for(let i of e){let p=n.createDiv({cls:"snapshot-item"}),l=p.createDiv({cls:"snapshot-info"});l.createEl("div",{text:new Date(i.timestamp).toLocaleString(),cls:"snapshot-time"}),l.createEl("div",{text:`${i.filePath} (${(i.size/1024).toFixed(2)} KB)`,cls:"snapshot-path"}),i.note&&l.createEl("div",{text:i.note,cls:"snapshot-note"});let S=p.createDiv({cls:"snapshot-actions"});new a.ButtonComponent(S).setButtonText("\u6062\u590D").onClick(async()=>{await this.plugin.restoreSnapshot(i),this.close()}),new a.ButtonComponent(S).setButtonText("\u67E5\u770B").onClick(()=>{new u(this.app,i).open()})}}onClose(){let{contentEl:t}=this;t.empty()}},u=class extends a.Modal{constructor(t,s){super(t);this.snapshot=s}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u5FEB\u7167\u5185\u5BB9"}),t.createEl("p",{text:`\u65F6\u95F4: ${new Date(this.snapshot.timestamp).toLocaleString()}`}),t.createEl("p",{text:`\u6587\u4EF6: ${this.snapshot.filePath}`}),t.createEl("pre",{cls:"snapshot-content"}).createEl("code",{text:this.snapshot.content})}onClose(){let{contentEl:t}=this;t.empty()}},d=class extends a.Modal{constructor(t,s){super(t);this.plugin=s}async onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"\u6062\u590D\u5FEB\u7167"});let s=this.app.workspace.getActiveFile();if(!s){t.createEl("p",{text:"\u8BF7\u5148\u6253\u5F00\u8981\u6062\u590D\u7684\u6587\u4EF6"});return}let e=await this.plugin.getSnapshots(s.path);if(e.length===0){t.createEl("p",{text:"\u8BE5\u6587\u4EF6\u6CA1\u6709\u5FEB\u7167"});return}for(let n of e){let i=t.createDiv({cls:"snapshot-restore-item"});i.createEl("span",{text:new Date(n.timestamp).toLocaleString()}),new a.ButtonComponent(i).setButtonText("\u6062\u590D\u6B64\u7248\u672C").onClick(async()=>{await this.plugin.restoreSnapshot(n),this.close()})}}onClose(){let{contentEl:t}=this;t.empty()}},m=class extends a.PluginSettingTab{constructor(t,s){super(t,s);this.plugin=s}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"\u5FEB\u7167\u7248\u672C\u63A7\u5236\u8BBE\u7F6E"}),new a.Setting(t).setName("\u5FEB\u7167\u5B58\u50A8\u6587\u4EF6\u5939").setDesc("\u5FEB\u7167\u6587\u4EF6\u7684\u5B58\u50A8\u4F4D\u7F6E").addText(s=>s.setPlaceholder(".snapshots").setValue(this.plugin.settings.snapshotFolder).onChange(async e=>{this.plugin.settings.snapshotFolder=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("\u81EA\u52A8\u5FEB\u7167").setDesc("\u5728\u6587\u4EF6\u4FEE\u6539\u65F6\u81EA\u52A8\u521B\u5EFA\u5FEB\u7167").addToggle(s=>s.setValue(this.plugin.settings.autoSnapshot).onChange(async e=>{this.plugin.settings.autoSnapshot=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("\u5FEB\u7167\u95F4\u9694\uFF08\u5206\u949F\uFF09").setDesc("\u81EA\u52A8\u5FEB\u7167\u7684\u65F6\u95F4\u95F4\u9694").addText(s=>s.setPlaceholder("30").setValue(String(this.plugin.settings.snapshotInterval)).onChange(async e=>{let n=parseInt(e);!isNaN(n)&&n>0&&(this.plugin.settings.snapshotInterval=n,await this.plugin.saveSettings())})),new a.Setting(t).setName("\u6700\u5927\u5FEB\u7167\u6570\u91CF").setDesc("\u6BCF\u4E2A\u6587\u4EF6\u4FDD\u7559\u7684\u6700\u5927\u5FEB\u7167\u6570\u91CF").addText(s=>s.setPlaceholder("50").setValue(String(this.plugin.settings.maxSnapshots)).onChange(async e=>{let n=parseInt(e);!isNaN(n)&&n>0&&(this.plugin.settings.maxSnapshots=n,await this.plugin.saveSettings())}))}};
