/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var O=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var re=Object.prototype.hasOwnProperty;var le=(a,n)=>{for(var e in n)O(a,e,{get:n[e],enumerable:!0})},ce=(a,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of ae(n))!re.call(a,i)&&i!==e&&O(a,i,{get:()=>n[i],enumerable:!(t=oe(n,i))||t.enumerable});return a};var fe=a=>ce(O({},"__esModule",{value:!0}),a);var ge={};le(ge,{default:()=>N});module.exports=fe(ge);var u=require("obsidian");var v=class{diff(n,e,t={}){let i;typeof t=="function"?(i=t,t={}):"callback"in t&&(i=t.callback);let s=this.castInput(n,t),o=this.castInput(e,t),r=this.removeEmpty(this.tokenize(s,t)),l=this.removeEmpty(this.tokenize(o,t));return this.diffWithOptionsObj(r,l,t,i)}diffWithOptionsObj(n,e,t,i){var s;let o=h=>{if(h=this.postProcess(h,t),i){setTimeout(function(){i(h)},0);return}else return h},r=e.length,l=n.length,c=1,f=r+l;t.maxEditLength!=null&&(f=Math.min(f,t.maxEditLength));let g=(s=t.timeout)!==null&&s!==void 0?s:1/0,w=Date.now()+g,m=[{oldPos:-1,lastComponent:void 0}],p=this.extractCommon(m[0],e,n,0,t);if(m[0].oldPos+1>=l&&p+1>=r)return o(this.buildValues(m[0].lastComponent,e,n));let V=-1/0,C=1/0,S=()=>{for(let h=Math.max(V,-c);h<=Math.min(C,c);h+=2){let d,y=m[h-1],E=m[h+1];y&&(m[h-1]=void 0);let b=!1;if(E){let Q=E.oldPos-h;b=E&&0<=Q&&Q<r}let Z=y&&y.oldPos+1<l;if(!b&&!Z){m[h]=void 0;continue}if(!Z||b&&y.oldPos<E.oldPos?d=this.addToPath(E,!0,!1,0,t):d=this.addToPath(y,!1,!0,1,t),p=this.extractCommon(d,e,n,h,t),d.oldPos+1>=l&&p+1>=r)return o(this.buildValues(d.lastComponent,e,n))||!0;m[h]=d,d.oldPos+1>=l&&(C=Math.min(C,h-1)),p+1>=r&&(V=Math.max(V,h+1))}c++};if(i)(function h(){setTimeout(function(){if(c>f||Date.now()>w)return i(void 0);S()||h()},0)})();else for(;c<=f&&Date.now()<=w;){let h=S();if(h)return h}}addToPath(n,e,t,i,s){let o=n.lastComponent;return o&&!s.oneChangePerToken&&o.added===e&&o.removed===t?{oldPos:n.oldPos+i,lastComponent:{count:o.count+1,added:e,removed:t,previousComponent:o.previousComponent}}:{oldPos:n.oldPos+i,lastComponent:{count:1,added:e,removed:t,previousComponent:o}}}extractCommon(n,e,t,i,s){let o=e.length,r=t.length,l=n.oldPos,c=l-i,f=0;for(;c+1<o&&l+1<r&&this.equals(t[l+1],e[c+1],s);)c++,l++,f++,s.oneChangePerToken&&(n.lastComponent={count:1,previousComponent:n.lastComponent,added:!1,removed:!1});return f&&!s.oneChangePerToken&&(n.lastComponent={count:f,previousComponent:n.lastComponent,added:!1,removed:!1}),n.oldPos=l,c}equals(n,e,t){return t.comparator?t.comparator(n,e):n===e||!!t.ignoreCase&&n.toLowerCase()===e.toLowerCase()}removeEmpty(n){let e=[];for(let t=0;t<n.length;t++)n[t]&&e.push(n[t]);return e}castInput(n,e){return n}tokenize(n,e){return Array.from(n)}join(n){return n.join("")}postProcess(n,e){return n}get useLongestToken(){return!1}buildValues(n,e,t){let i=[],s;for(;n;)i.push(n),s=n.previousComponent,delete n.previousComponent,n=s;i.reverse();let o=i.length,r=0,l=0,c=0;for(;r<o;r++){let f=i[r];if(f.removed)f.value=this.join(t.slice(c,c+f.count)),c+=f.count;else{if(!f.added&&this.useLongestToken){let g=e.slice(l,l+f.count);g=g.map(function(w,m){let p=t[c+m];return p.length>w.length?p:w}),f.value=this.join(g)}else f.value=this.join(e.slice(l,l+f.count));l+=f.count,f.added||(c+=f.count)}}return i}};var M=class extends v{},K=new M;function $(a,n,e){return K.diff(a,n,e)}function z(a,n){let e;for(e=0;e<a.length&&e<n.length;e++)if(a[e]!=n[e])return a.slice(0,e);return a.slice(0,e)}function B(a,n){let e;if(!a||!n||a[a.length-1]!=n[n.length-1])return"";for(e=0;e<a.length&&e<n.length;e++)if(a[a.length-(e+1)]!=n[n.length-(e+1)])return a.slice(-e);return a.slice(-e)}function F(a,n,e){if(a.slice(0,n.length)!=n)throw Error(`string ${JSON.stringify(a)} doesn't start with prefix ${JSON.stringify(n)}; this is a bug`);return e+a.slice(n.length)}function L(a,n,e){if(!n)return a+e;if(a.slice(-n.length)!=n)throw Error(`string ${JSON.stringify(a)} doesn't end with suffix ${JSON.stringify(n)}; this is a bug`);return a.slice(0,-n.length)+e}function D(a,n){return F(a,n,"")}function I(a,n){return L(a,n,"")}function j(a,n){return n.slice(0,ue(a,n))}function ue(a,n){let e=0;a.length>n.length&&(e=a.length-n.length);let t=n.length;a.length<n.length&&(t=a.length);let i=Array(t),s=0;i[0]=0;for(let o=1;o<t;o++){for(n[o]==n[s]?i[o]=i[s]:i[o]=s;s>0&&n[o]!=n[s];)s=i[s];n[o]==n[s]&&s++}s=0;for(let o=e;o<a.length;o++){for(;s>0&&a[o]!=n[s];)s=i[s];a[o]==n[s]&&s++}return s}function P(a){let n;for(n=a.length-1;n>=0&&a[n].match(/\s/);n--);return a.substring(n+1)}function x(a){let n=a.match(/^\s*/);return n?n[0]:""}var T="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",he=new RegExp(`[${T}]+|\\s+|[^${T}]`,"ug"),q=class extends v{equals(n,e,t){return t.ignoreCase&&(n=n.toLowerCase(),e=e.toLowerCase()),n.trim()===e.trim()}tokenize(n,e={}){let t;if(e.intlSegmenter){let o=e.intlSegmenter;if(o.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');t=Array.from(o.segment(n),r=>r.segment)}else t=n.match(he)||[];let i=[],s=null;return t.forEach(o=>{/\s/.test(o)?s==null?i.push(o):i.push(i.pop()+o):s!=null&&/\s/.test(s)?i[i.length-1]==s?i.push(i.pop()+o):i.push(s+o):i.push(o),s=o}),i}join(n){return n.map((e,t)=>t==0?e:e.replace(/^\s+/,"")).join("")}postProcess(n,e){if(!n||e.oneChangePerToken)return n;let t=null,i=null,s=null;return n.forEach(o=>{o.added?i=o:o.removed?s=o:((i||s)&&ee(t,s,i,o),t=o,i=null,s=null)}),(i||s)&&ee(t,s,i,null),n}},te=new q;function J(a,n,e){return(e==null?void 0:e.ignoreWhitespace)!=null&&!e.ignoreWhitespace?ie(a,n,e):te.diff(a,n,e)}function ee(a,n,e,t){if(n&&e){let i=x(n.value),s=P(n.value),o=x(e.value),r=P(e.value);if(a){let l=z(i,o);a.value=L(a.value,o,l),n.value=D(n.value,l),e.value=D(e.value,l)}if(t){let l=B(s,r);t.value=F(t.value,r,l),n.value=I(n.value,l),e.value=I(e.value,l)}}else if(e){if(a){let i=x(e.value);e.value=e.value.substring(i.length)}if(t){let i=x(t.value);t.value=t.value.substring(i.length)}}else if(a&&t){let i=x(t.value),s=x(n.value),o=P(n.value),r=z(i,s);n.value=D(n.value,r);let l=B(D(i,r),o);n.value=I(n.value,l),t.value=F(t.value,i,l),a.value=L(a.value,i,i.slice(0,i.length-l.length))}else if(t){let i=x(t.value),s=P(n.value),o=j(s,i);n.value=I(n.value,o)}else if(a){let i=P(a.value),s=x(n.value),o=j(i,s);n.value=D(n.value,o)}}var R=class extends v{tokenize(n){let e=new RegExp(`(\\r?\\n)|[${T}]+|[^\\S\\n\\r]+|[^${T}]`,"ug");return n.match(e)||[]}},ne=new R;function ie(a,n,e){return ne.diff(a,n,e)}var H=class extends v{constructor(){super(...arguments),this.tokenize=de}equals(n,e,t){return t.ignoreWhitespace?((!t.newlineIsToken||!n.includes(`
`))&&(n=n.trim()),(!t.newlineIsToken||!e.includes(`
`))&&(e=e.trim())):t.ignoreNewlineAtEof&&!t.newlineIsToken&&(n.endsWith(`
`)&&(n=n.slice(0,-1)),e.endsWith(`
`)&&(e=e.slice(0,-1))),super.equals(n,e,t)}},se=new H;function _(a,n,e){return se.diff(a,n,e)}function de(a,n){n.stripTrailingCr&&(a=a.replace(/\r\n/g,`
`));let e=[],t=a.split(/(\n|\r\n)/);t[t.length-1]||t.pop();for(let i=0;i<t.length;i++){let s=t[i];i%2&&!n.newlineIsToken?e[e.length-1]+=s:e.push(s)}return e}var pe={storageLocation:".versions",autoSaveEnabled:!0,autoSaveInterval:5,autoCleanEnabled:!0,maxVersionCount:50,maxVersionDays:30,cleanupStrategy:"both"},k="version-history-view",U=class extends u.ItemView{constructor(e,t){super(e);this.currentFile=null;this.versions=[];this.selectedVersions=new Set;this.plugin=t}getViewType(){return k}getDisplayText(){return"\u7248\u672C\u5386\u53F2"}getIcon(){return"history"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("version-history-container"),this.renderView(),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.updateCurrentFile()}))}async updateCurrentFile(){let e=this.app.workspace.getActiveFile();e&&e!==this.currentFile&&(this.currentFile=e,await this.loadVersions(),this.renderView())}async loadVersions(){this.currentFile&&(this.versions=await this.plugin.getVersions(this.currentFile.path),this.versions.sort((e,t)=>t.timestamp-e.timestamp))}renderView(){let e=this.containerEl.children[1];if(e.empty(),!this.currentFile){e.createEl("div",{text:"\u8BF7\u6253\u5F00\u4E00\u4E2A\u6587\u4EF6\u4EE5\u67E5\u770B\u5176\u7248\u672C\u5386\u53F2",cls:"version-empty-state"});return}let t=e.createEl("div",{cls:"version-header"});t.createEl("h4",{text:"\u7248\u672C\u5386\u53F2"}),t.createEl("div",{text:this.currentFile.basename,cls:"version-filename"});let i=e.createEl("div",{cls:"version-toolbar"}),s=i.createEl("button",{text:"\u521B\u5EFA\u7248\u672C",cls:"mod-cta"});if(s.onclick=()=>this.createManualVersion(),this.selectedVersions.size>0){let r=i.createEl("button",{text:`\u5220\u9664\u9009\u4E2D (${this.selectedVersions.size})`,cls:"mod-warning"});r.onclick=()=>this.deleteSelectedVersions()}let o=e.createEl("div",{cls:"version-list"});if(this.versions.length===0){o.createEl("div",{text:"\u6682\u65E0\u7248\u672C\u5386\u53F2",cls:"version-empty"});return}this.versions.forEach(r=>{let l=o.createEl("div",{cls:"version-item"}),c=l.createEl("input",{type:"checkbox",cls:"version-checkbox"});c.checked=this.selectedVersions.has(r.id),c.onchange=()=>{c.checked?this.selectedVersions.add(r.id):this.selectedVersions.delete(r.id),this.renderView()};let f=l.createEl("div",{cls:"version-info"}),w=new Date(r.timestamp).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});f.createEl("div",{text:w,cls:"version-timestamp"}),f.createEl("div",{text:r.message,cls:"version-message"});let m=(r.size/1024).toFixed(2);f.createEl("div",{text:`${m} KB`,cls:"version-size"});let p=l.createEl("div",{cls:"version-actions"}),V=p.createEl("button",{text:"\u6062\u590D",cls:"mod-cta"});V.onclick=()=>this.restoreVersion(r);let C=p.createEl("button",{text:"\u5BF9\u6BD4\u5F53\u524D"});C.onclick=()=>this.showDiff(r,null),l.oncontextmenu=S=>{S.preventDefault();let h=new u.Menu;h.addItem(d=>{d.setTitle("\u6062\u590D\u6B64\u7248\u672C").setIcon("reset").onClick(()=>this.restoreVersion(r))}),h.addItem(d=>{d.setTitle("\u5BF9\u6BD4\u5F53\u524D\u7248\u672C").setIcon("diff").onClick(()=>this.showDiff(r,null))}),h.addItem(d=>{d.setTitle("\u4E0E\u5176\u4ED6\u7248\u672C\u5BF9\u6BD4").setIcon("diff").onClick(()=>this.selectVersionForComparison(r))}),h.addItem(d=>{d.setTitle("\u5220\u9664\u6B64\u7248\u672C").setIcon("trash").onClick(()=>this.deleteVersion(r))}),h.showAtMouseEvent(S)}})}async createManualVersion(){if(!this.currentFile)return;new W(this.app,async t=>{await this.plugin.createVersion(this.currentFile,t),new u.Notice("\u7248\u672C\u521B\u5EFA\u6210\u529F"),await this.loadVersions(),this.renderView()}).open()}async restoreVersion(e){!this.currentFile||!await this.showRestoreWarning()||(await this.plugin.createVersion(this.currentFile,"[\u6062\u590D\u524D\u81EA\u52A8\u4FDD\u5B58]"),await this.app.vault.modify(this.currentFile,e.content),new u.Notice("\u7248\u672C\u5DF2\u6062\u590D"),await this.loadVersions(),this.renderView())}async showRestoreWarning(){return new Promise(e=>{new A(this.app,"\u786E\u8BA4\u6062\u590D\u7248\u672C","\u6062\u590D\u6B64\u7248\u672C\u5C06\u66FF\u6362\u5F53\u524D\u6587\u4EF6\u5185\u5BB9\u3002\u5F53\u524D\u5185\u5BB9\u4F1A\u81EA\u52A8\u4FDD\u5B58\u4E3A\u65B0\u7248\u672C\u3002\u662F\u5426\u7EE7\u7EED?",()=>e(!0),()=>e(!1)).open()})}showDiff(e,t){new G(this.app,this.currentFile,e,t).open()}selectVersionForComparison(e){new Y(this.app,this.versions.filter(i=>i.id!==e.id),i=>{this.showDiff(e,i)}).open()}async deleteVersion(e){await this.plugin.deleteVersion(e.id),new u.Notice("\u7248\u672C\u5DF2\u5220\u9664"),await this.loadVersions(),this.renderView()}async deleteSelectedVersions(){let e=this.selectedVersions.size;if(await new Promise(i=>{new A(this.app,"\u786E\u8BA4\u5220\u9664",`\u786E\u5B9A\u8981\u5220\u9664\u9009\u4E2D\u7684 ${e} \u4E2A\u7248\u672C\u5417?`,()=>i(!0),()=>i(!1)).open()})){for(let i of this.selectedVersions)await this.plugin.deleteVersion(i);this.selectedVersions.clear(),new u.Notice(`\u5DF2\u5220\u9664 ${e} \u4E2A\u7248\u672C`),await this.loadVersions(),this.renderView()}}},W=class extends u.Modal{constructor(e,t){super(e);this.message="";this.onSubmit=t}onOpen(){let{contentEl:e}=this;e.createEl("h3",{text:"\u521B\u5EFA\u7248\u672C"});let i=e.createDiv().createEl("input",{type:"text",placeholder:"\u8F93\u5165\u63D0\u4EA4\u4FE1\u606F (\u53EF\u9009)",cls:"version-message-input"});i.style.width="100%",i.style.marginBottom="1em",i.oninput=()=>{this.message=i.value};let s=e.createDiv({cls:"modal-button-container"}),o=s.createEl("button",{text:"\u521B\u5EFA",cls:"mod-cta"});o.onclick=()=>{this.onSubmit(this.message||"[\u624B\u52A8\u4FDD\u5B58]"),this.close()};let r=s.createEl("button",{text:"\u53D6\u6D88"});r.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},A=class extends u.Modal{constructor(e,t,i,s,o){super(e);this.title=t,this.message=i,this.onConfirm=s,this.onCancel=o}onOpen(){let{contentEl:e}=this;e.createEl("h3",{text:this.title}),e.createEl("p",{text:this.message});let t=e.createDiv({cls:"modal-button-container"}),i=t.createEl("button",{text:"\u786E\u8BA4",cls:"mod-warning"});i.onclick=()=>{this.onConfirm(),this.close()};let s=t.createEl("button",{text:"\u53D6\u6D88"});s.onclick=()=>{this.onCancel(),this.close()}}onClose(){let{contentEl:e}=this;e.empty()}},Y=class extends u.Modal{constructor(e,t,i){super(e);this.versions=t,this.onSelect=i}onOpen(){let{contentEl:e}=this;e.createEl("h3",{text:"\u9009\u62E9\u5BF9\u6BD4\u7248\u672C"});let t=e.createDiv({cls:"version-select-list"});this.versions.forEach(i=>{let s=t.createEl("div",{cls:"version-select-item"}),r=new Date(i.timestamp).toLocaleString("zh-CN");s.createEl("div",{text:r,cls:"version-timestamp"}),s.createEl("div",{text:i.message,cls:"version-message"}),s.onclick=()=>{this.onSelect(i),this.close()}})}onClose(){let{contentEl:e}=this;e.empty()}},G=class extends u.Modal{constructor(e,t,i,s){super(e);this.diffMode="unified";this.diffLevel="char";this.diffs=[];this.currentDiffIndex=0;this.file=t,this.version1=i,this.version2=s}async onOpen(){let{contentEl:e}=this;e.addClass("diff-modal");let t=this.version1.content,i=this.version2?this.version2.content:await this.app.vault.read(this.file),s=e.createDiv({cls:"diff-toolbar"}),o=s.createDiv({cls:"diff-version-info"}),r=new Date(this.version1.timestamp).toLocaleString("zh-CN"),l=this.version2?new Date(this.version2.timestamp).toLocaleString("zh-CN"):"\u5F53\u524D\u7248\u672C";o.createEl("span",{text:`\u5BF9\u6BD4: ${r} \u2194 ${l}`});let c=s.createDiv({cls:"diff-view-toggle"}),f=c.createEl("button",{text:"\u7EDF\u4E00\u89C6\u56FE",cls:this.diffMode==="unified"?"is-active":""});f.onclick=()=>{this.diffMode="unified",this.renderDiff(t,i)};let g=c.createEl("button",{text:"\u5206\u680F\u89C6\u56FE",cls:this.diffMode==="split"?"is-active":""});g.onclick=()=>{this.diffMode="split",this.renderDiff(t,i)};let w=s.createDiv({cls:"diff-level-toggle"});["\u5B57\u7B26\u7EA7","\u5355\u8BCD\u7EA7","\u884C\u7EA7"].forEach((h,d)=>{let E=["char","word","line"][d],b=w.createEl("button",{text:h,cls:this.diffLevel===E?"is-active":""});b.onclick=()=>{this.diffLevel=E,this.renderDiff(t,i)}});let m=s.createDiv({cls:"diff-navigation"}),p=m.createEl("button",{text:"\u4E0A\u4E00\u4E2A"}),V=m.createEl("span",{cls:"diff-count"}),C=m.createEl("button",{text:"\u4E0B\u4E00\u4E2A"});p.onclick=()=>this.navigateDiff(-1),C.onclick=()=>this.navigateDiff(1);let S=e.createDiv({cls:"diff-container"});this.renderDiff(t,i)}renderDiff(e,t){let i=this.contentEl.querySelector(".diff-container"),s=this.contentEl.querySelector(".diff-count");if(!i)return;i.empty();let o;this.diffLevel==="char"?o=$(e,t):this.diffLevel==="word"?o=J(e,t):o=_(e,t),this.diffs=o.filter(r=>r.added||r.removed),this.currentDiffIndex=0,s&&s.setText(this.diffs.length>0?`(${this.currentDiffIndex+1} / ${this.diffs.length})`:"(0 / 0)"),this.diffMode==="unified"?this.renderUnifiedDiff(i,o):this.renderSplitDiff(i,e,t)}renderUnifiedDiff(e,t){let i=e.createEl("pre",{cls:"diff-unified"});t.forEach((s,o)=>{let r=i.createEl("span",{cls:s.added?"diff-added":s.removed?"diff-removed":"diff-unchanged",attr:{"data-diff-index":o}});r.textContent=s.value})}renderSplitDiff(e,t,i){let s=e.createDiv({cls:"diff-split"}),o=s.createDiv({cls:"diff-pane"});o.createEl("h4",{text:"\u539F\u7248\u672C"});let r=o.createEl("pre");r.textContent=t;let l=s.createDiv({cls:"diff-pane"});l.createEl("h4",{text:"\u65B0\u7248\u672C"});let c=l.createEl("pre");c.textContent=i}navigateDiff(e){if(this.diffs.length===0)return;this.currentDiffIndex+=e,this.currentDiffIndex<0&&(this.currentDiffIndex=this.diffs.length-1),this.currentDiffIndex>=this.diffs.length&&(this.currentDiffIndex=0);let t=this.contentEl.querySelector(".diff-count");t&&t.setText(`(${this.currentDiffIndex+1} / ${this.diffs.length})`);let i=this.contentEl.querySelectorAll("[data-diff-index]");i[this.currentDiffIndex]&&i[this.currentDiffIndex].scrollIntoView({behavior:"smooth",block:"center"})}onClose(){let{contentEl:e}=this;e.empty()}},N=class extends u.Plugin{constructor(){super(...arguments);this.autoSaveInterval=null;this.fileChangeTracking=new Map}async onload(){await this.loadSettings(),this.registerView(k,e=>new U(e,this)),this.addRibbonIcon("history","\u7248\u672C\u5386\u53F2",()=>{this.activateView()}),this.addCommand({id:"create-version",name:"\u521B\u5EFA\u7248\u672C\u5FEB\u7167",callback:()=>this.createVersionCommand()}),this.addCommand({id:"open-version-history",name:"\u6253\u5F00\u7248\u672C\u5386\u53F2",callback:()=>this.activateView()}),this.addSettingTab(new X(this.app,this)),this.settings.autoSaveEnabled&&this.startAutoSave(),this.settings.autoCleanEnabled&&this.scheduleAutoClean(),console.log("\u7248\u672C\u63A7\u5236\u63D2\u4EF6\u5DF2\u52A0\u8F7D")}async activateView(){let{workspace:e}=this.app,t=null,i=e.getLeavesOfType(k);i.length>0?t=i[0]:(t=e.getRightLeaf(!1),await t.setViewState({type:k,active:!0})),e.revealLeaf(t)}startAutoSave(){this.autoSaveInterval&&window.clearInterval(this.autoSaveInterval);let e=this.settings.autoSaveInterval*60*1e3;this.autoSaveInterval=window.setInterval(()=>{this.autoSaveCheck()},e),this.registerInterval(this.autoSaveInterval)}async autoSaveCheck(){let e=this.app.vault.getMarkdownFiles();for(let t of e){let i=await this.app.vault.read(t);this.fileChangeTracking.get(t.path)!==i&&(await this.createVersion(t,"[\u81EA\u52A8\u4FDD\u5B58]"),this.fileChangeTracking.set(t.path,i))}}scheduleAutoClean(){let t=window.setInterval(()=>{this.autoCleanVersions()},36e5);this.registerInterval(t)}async autoCleanVersions(){let e=await this.getAllVersions(),t=Date.now(),i=this.settings.maxVersionDays*24*60*60*1e3,s=new Map;for(let o of e)s.has(o.filePath)||s.set(o.filePath,[]),s.get(o.filePath).push(o);for(let[o,r]of s){r.sort((c,f)=>f.timestamp-c.timestamp);let l=[];if(this.settings.cleanupStrategy==="days-first"){r.forEach(f=>{t-f.timestamp>i&&l.push(f.id)});let c=r.filter(f=>!l.includes(f.id));c.length>this.settings.maxVersionCount&&c.slice(this.settings.maxVersionCount).forEach(g=>l.push(g.id))}else this.settings.cleanupStrategy==="count-first"?(r.length>this.settings.maxVersionCount&&r.slice(this.settings.maxVersionCount).forEach(f=>l.push(f.id)),r.forEach(c=>{t-c.timestamp>i&&!l.includes(c.id)&&l.push(c.id)})):r.forEach((c,f)=>{(t-c.timestamp>i||f>=this.settings.maxVersionCount)&&l.push(c.id)});for(let c of l)await this.deleteVersion(c)}}async createVersionCommand(){let e=this.app.workspace.getActiveFile();if(!e){new u.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u6587\u4EF6");return}new W(this.app,async i=>{await this.createVersion(e,i),new u.Notice("\u7248\u672C\u521B\u5EFA\u6210\u529F")}).open()}async createVersion(e,t){let i=await this.app.vault.read(e),s={id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),message:t,content:i,size:new Blob([i]).size,filePath:e.path};await this.saveVersion(s),this.fileChangeTracking.set(e.path,i)}async saveVersion(e){let t=`${this.settings.storageLocation}/${e.id}.json`;await this.app.vault.adapter.write(t,JSON.stringify(e))}async getVersions(e){let t=[];try{let i=await this.app.vault.adapter.list(this.settings.storageLocation);for(let s of i.files)if(s.endsWith(".json")){let o=await this.app.vault.adapter.read(s),r=JSON.parse(o);r.filePath===e&&t.push(r)}}catch(i){console.error("\u8BFB\u53D6\u7248\u672C\u5931\u8D25:",i)}return t}async getAllVersions(){let e=[];try{let t=await this.app.vault.adapter.list(this.settings.storageLocation);for(let i of t.files)if(i.endsWith(".json")){let s=await this.app.vault.adapter.read(i),o=JSON.parse(s);e.push(o)}}catch(t){console.error("\u8BFB\u53D6\u7248\u672C\u5931\u8D25:",t)}return e}async deleteVersion(e){let t=`${this.settings.storageLocation}/${e}.json`;try{await this.app.vault.adapter.remove(t)}catch(i){console.error("\u5220\u9664\u7248\u672C\u5931\u8D25:",i)}}async loadSettings(){this.settings=Object.assign({},pe,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}onunload(){this.autoSaveInterval&&window.clearInterval(this.autoSaveInterval),console.log("\u7248\u672C\u63A7\u5236\u63D2\u4EF6\u5DF2\u5378\u8F7D")}},X=class extends u.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"\u7248\u672C\u63A7\u5236\u8BBE\u7F6E"}),new u.Setting(e).setName("\u5B58\u50A8\u4F4D\u7F6E").setDesc("\u7248\u672C\u6570\u636E\u7684\u5B58\u50A8\u8DEF\u5F84 (\u76F8\u5BF9\u4E8E\u5E93\u6839\u76EE\u5F55)").addText(i=>i.setPlaceholder(".versions").setValue(this.plugin.settings.storageLocation).onChange(async s=>{this.plugin.settings.storageLocation=s||".versions",await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u81EA\u52A8\u4FDD\u5B58"}),new u.Setting(e).setName("\u542F\u7528\u81EA\u52A8\u4FDD\u5B58").setDesc("\u5B9A\u671F\u81EA\u52A8\u4E3A\u4FEE\u6539\u7684\u6587\u4EF6\u521B\u5EFA\u7248\u672C").addToggle(i=>i.setValue(this.plugin.settings.autoSaveEnabled).onChange(async s=>{this.plugin.settings.autoSaveEnabled=s,await this.plugin.saveSettings(),s?(this.plugin.startAutoSave(),new u.Notice("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u542F\u7528")):(this.plugin.autoSaveInterval&&(window.clearInterval(this.plugin.autoSaveInterval),this.plugin.autoSaveInterval=null),new u.Notice("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u7981\u7528"))})),new u.Setting(e).setName("\u81EA\u52A8\u4FDD\u5B58\u95F4\u9694 (\u5206\u949F)").setDesc("\u6BCF\u9694\u591A\u5C11\u5206\u949F\u68C0\u67E5\u5E76\u4FDD\u5B58\u4FEE\u6539\u7684\u6587\u4EF6").addText(i=>i.setPlaceholder("5").setValue(String(this.plugin.settings.autoSaveInterval)).onChange(async s=>{let o=parseInt(s);!isNaN(o)&&o>0&&(this.plugin.settings.autoSaveInterval=o,await this.plugin.saveSettings(),this.plugin.settings.autoSaveEnabled&&(this.plugin.startAutoSave(),new u.Notice(`\u81EA\u52A8\u4FDD\u5B58\u95F4\u9694\u5DF2\u66F4\u65B0\u4E3A ${o} \u5206\u949F`)))})),e.createEl("h3",{text:"\u81EA\u52A8\u6E05\u7406"}),new u.Setting(e).setName("\u542F\u7528\u81EA\u52A8\u6E05\u7406").setDesc("\u81EA\u52A8\u5220\u9664\u8D85\u8FC7\u9650\u5236\u7684\u65E7\u7248\u672C\u4EE5\u8282\u7701\u7A7A\u95F4").addToggle(i=>i.setValue(this.plugin.settings.autoCleanEnabled).onChange(async s=>{this.plugin.settings.autoCleanEnabled=s,await this.plugin.saveSettings(),new u.Notice(s?"\u81EA\u52A8\u6E05\u7406\u5DF2\u542F\u7528":"\u81EA\u52A8\u6E05\u7406\u5DF2\u7981\u7528")})),new u.Setting(e).setName("\u4FDD\u7559\u6570\u91CF\u4E0A\u9650").setDesc("\u6BCF\u4E2A\u6587\u4EF6\u6700\u591A\u4FDD\u7559\u591A\u5C11\u4E2A\u7248\u672C").addText(i=>i.setPlaceholder("50").setValue(String(this.plugin.settings.maxVersionCount)).onChange(async s=>{let o=parseInt(s);!isNaN(o)&&o>0&&(this.plugin.settings.maxVersionCount=o,await this.plugin.saveSettings())})),new u.Setting(e).setName("\u4FDD\u7559\u5929\u6570").setDesc("\u7248\u672C\u6700\u591A\u4FDD\u7559\u591A\u5C11\u5929").addText(i=>i.setPlaceholder("30").setValue(String(this.plugin.settings.maxVersionDays)).onChange(async s=>{let o=parseInt(s);!isNaN(o)&&o>0&&(this.plugin.settings.maxVersionDays=o,await this.plugin.saveSettings())})),new u.Setting(e).setName("\u6E05\u7406\u7B56\u7565").setDesc("\u5982\u4F55\u51B3\u5B9A\u5220\u9664\u54EA\u4E9B\u7248\u672C").addDropdown(i=>i.addOption("days-first","\u5148\u6309\u5929\u6570,\u518D\u6309\u6570\u91CF").addOption("count-first","\u5148\u6309\u6570\u91CF,\u518D\u6309\u5929\u6570").addOption("both","\u540C\u65F6\u6EE1\u8DB3\u4E24\u4E2A\u6761\u4EF6").setValue(this.plugin.settings.cleanupStrategy).onChange(async s=>{this.plugin.settings.cleanupStrategy=s,await this.plugin.saveSettings()})),new u.Setting(e).setName("\u7ACB\u5373\u6E05\u7406").setDesc("\u7ACB\u5373\u6267\u884C\u4E00\u6B21\u7248\u672C\u6E05\u7406").addButton(i=>i.setButtonText("\u6E05\u7406\u65E7\u7248\u672C").setCta().onClick(async()=>{await this.plugin.autoCleanVersions(),new u.Notice("\u7248\u672C\u6E05\u7406\u5B8C\u6210")})),e.createEl("h3",{text:"\u7EDF\u8BA1\u4FE1\u606F"});let t=e.createDiv({cls:"version-stats"});this.updateStats(t)}async updateStats(e){e.empty();try{let t=await this.plugin.getAllVersions(),i=t.reduce((o,r)=>o+r.size,0),s=new Set(t.map(o=>o.filePath)).size;e.createEl("p",{text:`\u603B\u7248\u672C\u6570: ${t.length}`}),e.createEl("p",{text:`\u6D89\u53CA\u6587\u4EF6: ${s}`}),e.createEl("p",{text:`\u603B\u5927\u5C0F: ${(i/1024/1024).toFixed(2)} MB`})}catch(t){e.createEl("p",{text:"\u65E0\u6CD5\u8BFB\u53D6\u7EDF\u8BA1\u4FE1\u606F",cls:"mod-warning"})}}};
